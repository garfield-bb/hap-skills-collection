---
name: hap-view-plugin
description: åˆ›å»ºå’Œå¼€å‘æ˜é“äº‘ HAP è‡ªå®šä¹‰è§†å›¾æ’ä»¶çš„æŠ€èƒ½ã€‚æ­¤æŠ€èƒ½åº”è¯¥åœ¨ä½¿ç”¨è€…éœ€è¦å¼€å‘ HAP è‡ªå®šä¹‰è§†å›¾æ’ä»¶ã€åˆå§‹åŒ–æœ¬åœ°å¼€å‘ç¯å¢ƒã€å®‰è£…ä¾èµ–ã€å¯åŠ¨è°ƒè¯•æ—¶ä½¿ç”¨ã€‚
license: MIT
---

# HAP è‡ªå®šä¹‰è§†å›¾æ’ä»¶å¼€å‘æŠ€èƒ½

æ­¤æŠ€èƒ½æä¾›åˆ›å»ºå’Œå¼€å‘æ˜é“äº‘ HAP è‡ªå®šä¹‰è§†å›¾æ’ä»¶çš„å®Œæ•´å·¥ä½œæµç¨‹å’Œå¼€å‘è§„èŒƒã€‚

## å…³äºæ­¤æŠ€èƒ½

æ­¤æŠ€èƒ½ä¸“é—¨ç”¨äºå¼€å‘æ˜é“äº‘ HAPï¼ˆHigh-performance Application Platformï¼‰è‡ªå®šä¹‰è§†å›¾æ’ä»¶ã€‚é€šè¿‡é›†æˆçš„è„šæ‰‹æ¶å·¥å…·ï¼Œå¯ä»¥å¿«é€Ÿåˆ›å»º React åŸºç¡€ç¤ºä¾‹æ¨¡æ¿é¡¹ç›®ï¼Œå®‰è£…ä¾èµ–å¹¶å¯åŠ¨å¼€å‘ç¯å¢ƒã€‚

### å‰ç½®æ¡ä»¶

åœ¨ä½¿ç”¨æ­¤æŠ€èƒ½å‰ï¼Œç¡®ä¿ï¼š
1. å·²å®‰è£… 16.20 æˆ–æ›´é«˜ç‰ˆæœ¬çš„ Node.js
2. æ‹¥æœ‰æ˜é“äº‘å¼€å‘è€…è´¦å·å’Œæ’ä»¶å¼€å‘æƒé™
3. äº†è§£åŸºæœ¬çš„ React å¼€å‘çŸ¥è¯†

### å¼€å‘ç¯å¢ƒé…ç½®

#### Cursor ç¼–è¾‘å™¨é…ç½®

ä¸‹è½½ `mdye-cursorrules.md` æ–‡ä»¶å¹¶å¤åˆ¶å…¶ä¸­å†…å®¹åˆ°è§†å›¾å¼€å‘é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `.cursorrules` æ–‡ä»¶ä¸­ï¼Œå³å¯åœ¨ Cursor ç¼–è¾‘å™¨ä¸­è·å¾—æ˜é“äº‘è§†å›¾æ’ä»¶å¼€å‘çš„æ™ºèƒ½æç¤ºå’Œä»£ç è§„èŒƒæ£€æŸ¥ã€‚

#### æ•™å­¦ DEMO

è¯·ä¸‹è½½æ˜é“äº‘è§†å›¾æ’ä»¶å¼€å‘æ•™å­¦ DEMOï¼Œæ­¤æ’ä»¶ä¸ºå¼€å‘è€…æä¾›ç›´è§‚ã€å¯äº¤äº’çš„ API ä½¿ç”¨å®ä¾‹ã€‚

### æ ¸å¿ƒåŠŸèƒ½

#### 1. å®‰è£… mdye-cli å·¥å…·
- å…¨å±€å®‰è£…æ’ä»¶å¼€å‘ä¸“ç”¨çš„å‘½ä»¤è¡Œå·¥å…·
- éªŒè¯å·¥å…·å®‰è£…æ˜¯å¦æˆåŠŸ

#### 2. åˆå§‹åŒ–æœ¬åœ°é¡¹ç›®
- åˆ›å»ºå”¯ä¸€çš„æ’ä»¶é¡¹ç›®æ–‡ä»¶å¤¹
- ä½¿ç”¨ React åŸºç¡€ç¤ºä¾‹æ¨¡æ¿
- ç”Ÿæˆé¡¹ç›®é…ç½®æ–‡ä»¶

#### 3. å®‰è£…é¡¹ç›®ä¾èµ–
- å®‰è£…é¡¹ç›®æ‰€éœ€çš„ npm ä¾èµ–åŒ…
- é…ç½®å¼€å‘ç¯å¢ƒ

#### 4. å¯åŠ¨å¼€å‘ç¯å¢ƒ
- å¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨
- æ”¯æŒçƒ­é‡è½½å’Œå®æ—¶é¢„è§ˆ
- æä¾›çº¿ä¸Šè°ƒè¯•èƒ½åŠ›

## å¼€å‘å·¥ä½œæµç¨‹

### æ­¥éª¤ 1ï¼šæ£€æŸ¥å¹¶å®‰è£… mdye-cli å·¥å…·

**é¦–å…ˆæ£€æŸ¥æ˜¯å¦å·²å®‰è£…ï¼š**
```bash
mdye --version
```

å¦‚æœæ˜¾ç¤ºç‰ˆæœ¬å·ï¼Œè¯´æ˜å·²å®‰è£…ï¼Œå¯ä»¥è·³è¿‡å®‰è£…æ­¥éª¤ã€‚

**å¦‚æœæœªå®‰è£…ï¼Œæ ¹æ®ç³»ç»Ÿå®‰è£…ï¼š**

**Mac OS ç”¨æˆ·ï¼š**
```bash
sudo npm install -g mdye-cli
```

**Windows/Linux ç”¨æˆ·ï¼š**
```bash
npm install -g mdye-cli
```

**éªŒè¯å®‰è£…ï¼š**
```bash
mdye --version
```

### æ­¥éª¤ 2ï¼šåˆå§‹åŒ–æœ¬åœ°é¡¹ç›®

**åˆ›å»ºé¡¹ç›®å‘½ä»¤ï¼š**
```bash
mdye init view --id 693d2fed8474b99be3d3c12e-69563e5df03728c888c04f05 --template React
```

**å‚æ•°è¯´æ˜ï¼š**
- `--id`: æ’ä»¶ IDï¼ˆç¤ºä¾‹ IDï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦æ›¿æ¢ï¼‰
- `--template React`: ä½¿ç”¨ React åŸºç¡€ç¤ºä¾‹æ¨¡æ¿

**é¡¹ç›®ç»“æ„ï¼š**
```
mdye_view_69563e5df03728c888c04f05/
â”œâ”€â”€ package.json
â”œâ”€â”€ mdye.json
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.jsx
â”‚   â”œâ”€â”€ App.jsx
â”‚   â””â”€â”€ styles.less
â””â”€â”€ .gitignore
```

### æ­¥éª¤ 3ï¼šè¿›å…¥é¡¹ç›®ç›®å½•å¹¶å®‰è£…ä¾èµ–

**è¿›å…¥é¡¹ç›®ç›®å½•ï¼š**
```bash
cd mdye_view_69563e5df03728c888c04f05
```

**å®‰è£…ä¾èµ–ï¼š**
```bash
npm i
```

### æ­¥éª¤ 4ï¼šå¯åŠ¨å¼€å‘ç¯å¢ƒ

**å¯åŠ¨å‘½ä»¤ï¼š**
```bash
mdye start
```

**å¯åŠ¨åï¼š**
- å¼€å‘æœåŠ¡å™¨å°†åœ¨ `http://localhost:3000/` å¯åŠ¨
- å°†è°ƒè¯•åœ°å€ `http://localhost:3000/bundle.js` ç²˜è´´åˆ°æ˜é“äº‘è§†å›¾é…ç½®å¼€å‘è°ƒè¯•è¾“å…¥æ¡†
- æ”¯æŒå®æ—¶ç¼–è¾‘å’Œçƒ­é‡è½½

## HAP äº§å“çº¿è¯´æ˜

### ğŸŒ å¤šäº§å“çº¿æ”¯æŒ

HAP æ”¯æŒå¤šä¸ªäº§å“çº¿å’Œç§æœ‰éƒ¨ç½²ï¼Œåœ¨è§†å›¾æ’ä»¶ä¸­è°ƒç”¨ API æ—¶éœ€è¦æ³¨æ„ **host é…ç½®**ï¼š

| äº§å“çº¿ | API Host | è¯´æ˜ |
|--------|----------|------|
| **æ˜é“äº‘ HAP** | `https://api.mingdao.com` | å®˜æ–¹ SaaS æœåŠ¡ |
| **Nocoly HAP** | `https://www.nocoly.com` | Nocoly SaaS æœåŠ¡ |
| **ç§æœ‰éƒ¨ç½² HAP** | `https://your-domain.com/api` | âš ï¸ **æ³¨æ„ï¼šç§æœ‰éƒ¨ç½²éœ€è¦åœ¨åŸŸåååŠ  `/api`** |

**ç¤ºä¾‹**ï¼š
- æ˜é“äº‘ï¼š`https://api.mingdao.com/v3/open/worksheet/getFilterRows`
- ç§æœ‰éƒ¨ç½²ï¼š`https://p-demo.mingdaoyun.cn/api/v3/open/worksheet/getFilterRows` â† æ³¨æ„ `/api`

**å»ºè®®**ï¼šè§†å›¾æ’ä»¶åº”è¯¥ä» `window.mdye.env` ä¸­è·å– host é…ç½®ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç ã€‚

---

## API ä½¿ç”¨æŒ‡å—

### 1. ç¯å¢ƒå˜é‡åŠé…ç½®è·å–

#### 1.1 è·å– env ç¯å¢ƒå˜é‡

```javascript
// ä½¿ç”¨è¾…åŠ©å‡½æ•°å®‰å…¨è·å–envä¸­çš„é…ç½®é¡¹
function getEnvValue(env, key, defaultValue = null) {
  if (!env || !key) return defaultValue;

  const value = env[key];

  // å¤„ç†æ•°ç»„ç±»å‹(å­—æ®µé€‰æ‹©å™¨)
  if (Array.isArray(value)) {
    return value.length > 0 ? value[0] : defaultValue;
  }

  // å¤„ç†æ™®é€šå€¼
  return value !== undefined ? value : defaultValue;
}

// ä½¿ç”¨ç¤ºä¾‹
const titleFieldId = getEnvValue(env, 'title');
const maxRecords = getEnvValue(env, 'maxRecords', '50');
```

#### 1.2 è·å– config é…ç½®

```javascript
import { config } from "mdye";

// è·å–åº”ç”¨ã€å·¥ä½œè¡¨ã€è§†å›¾çš„ID
const { appId, worksheetId, viewId, controls } = config;

// è·å–å­—æ®µæ§ä»¶ä¿¡æ¯
const fieldControl = _.find(controls, { controlId: fieldId });
```

### 2. æ•°æ®è·å– API

#### 2.1 è·å–å·¥ä½œè¡¨æ•°æ® (getFilterRows)

```javascript
import { api } from "mdye";

async function loadRecords() {
  const result = await api.getFilterRows({
    worksheetId,     // å¿…å¡«-å·¥ä½œè¡¨ID
    viewId,          // å¿…å¡«-è§†å›¾ID
    pageIndex: 1,    // å¯é€‰-é¡µç 
    pageSize: 50,    // å¯é€‰-æ¯é¡µè®°å½•æ•°
    sortId: "fieldId", // å¯é€‰-æ’åºå­—æ®µ
    isAsc: true,     // å¯é€‰-å‡åºæ’åº
    // è·å–å…³è”å­—æ®µæ•°æ®
    requestParams: {
      plugin_detail_control: relationFieldId
    }
  });

  return result.data; // è®°å½•æ•°ç»„
}
```

#### 2.2 è·å–è®°å½•è¯¦æƒ… (getRowDetail)

```javascript
async function getRecordDetail(rowId) {
  const result = await api.getRowDetail({
    appId,
    worksheetId,
    viewId,
    rowId
  });

  return result.data;
}
```

#### 2.3 è·å–å…³è”è®°å½• (getRowRelationRows)

```javascript
async function loadRelationRows({ controlId, rowId }) {
  const result = await api.getRowRelationRows({
    worksheetId,
    controlId,       // å…³è”å­—æ®µID
    rowId,           // ä¸»è®°å½•ID
    pageIndex: 1,
    pageSize: 10
  });

  return result.data;
}
```

### 3. æ•°æ®æ“ä½œ API

#### 3.1 æ–°å¢è®°å½• (addWorksheetRow)

```javascript
async function addRecord(fieldsData) {
  const response = await api.addWorksheetRow({
    appId,
    worksheetId,
    receiveControls: [
      {
        controlId: "fieldId1",
        type: 2,
        value: "æµ‹è¯•æ–‡æœ¬"
      }
    ]
  });
  return response;
}
```

#### 3.2 æ›´æ–°è®°å½• (updateWorksheetRow)

```javascript
async function updateRecord(rowId, fieldId, newValue) {
  const response = await api.updateWorksheetRow({
    appId,
    worksheetId,
    rowId,
    newOldControl: [
      {
        controlId: fieldId,
        type: 2,
        value: newValue
      }
    ]
  });
  return response;
}
```

#### 3.3 åˆ é™¤è®°å½• (deleteWorksheetRow)

```javascript
async function deleteRecord(rowId) {
  const response = await api.deleteWorksheetRow({
    appId,
    worksheetId,
    rowIds: [rowId]
  });
  return response;
}
```

### 4. å·¥å…·å‡½æ•° (utils)

#### 4.1 æ‰“å¼€è®°å½•è¯¦æƒ…ï¼ˆæ¨èä½¿ç”¨ï¼ï¼‰

**ä½¿ç”¨ `utils.openRecordInfo` æ‰“å¼€æ˜é“äº‘åŸç”Ÿè¡Œè®°å½•ç»„ä»¶æ˜¯æœ€ä½³å®è·µ:**

ä¼˜åŠ¿:
- âœ… åŸç”Ÿä½“éªŒ,ä¸æ˜é“äº‘ç•Œé¢ä¸€è‡´
- âœ… åŠŸèƒ½å®Œæ•´:æ”¯æŒç¼–è¾‘ã€åˆ é™¤ã€è®¨è®ºã€æ—¥å¿—ã€é™„ä»¶ç­‰æ‰€æœ‰åŠŸèƒ½
- âœ… è‡ªåŠ¨å¤„ç†æƒé™éªŒè¯
- âœ… æ— éœ€è‡ªå·±å¼€å‘å¼¹çª— UI
- âœ… è¿”å›æ“ä½œç»“æœ,æ–¹ä¾¿è¿›è¡Œæ•°æ®åŒæ­¥

**åŸºç¡€ç”¨æ³•:**

```javascript
import { utils } from "mdye";

// æ‰“å¼€è®°å½•è¯¦æƒ…
const handleRecordClick = async (recordId) => {
  try {
    const result = await utils.openRecordInfo({
      appId,
      worksheetId,
      viewId,
      recordId
    });

    // å¤„ç†è¿”å›ç»“æœ
    if (result) {
      console.log('æ“ä½œç»“æœ:', result);

      // æ ¹æ®æ“ä½œç±»å‹å¤„ç†
      switch (result.action) {
        case 'update':
          // è®°å½•è¢«æ›´æ–°,åˆ·æ–°æ•°æ®
          console.log('è®°å½•å·²æ›´æ–°:', result.value);
          loadRecords(); // é‡æ–°åŠ è½½æ•°æ®
          break;
        case 'delete':
          // è®°å½•è¢«åˆ é™¤,åˆ·æ–°åˆ—è¡¨
          console.log('è®°å½•å·²åˆ é™¤');
          loadRecords(); // é‡æ–°åŠ è½½æ•°æ®
          break;
        case 'close':
          // ç”¨æˆ·å…³é—­å¼¹çª—(æ— ä¿®æ”¹)
          console.log('ç”¨æˆ·å…³é—­äº†å¼¹çª—');
          break;
      }
    }
  } catch (error) {
    console.error('æ‰“å¼€è®°å½•è¯¦æƒ…å¤±è´¥:', error);
  }
};
```

**è¿”å›å€¼è¯´æ˜:**

```javascript
{
  action: 'update' | 'delete' | 'close',  // æ“ä½œç±»å‹
  value: object | null                     // æ›´æ–°åçš„è®°å½•æ•°æ®(ä»… action='update' æ—¶)
}
```

**å®Œæ•´çš„ React Hook ç¤ºä¾‹(åŒ…å«è‡ªåŠ¨åˆ·æ–°):**

```javascript
import React, { useEffect, useState } from 'react';
import { config, api, utils } from 'mdye';

function RecordsList() {
  const { appId, worksheetId, viewId } = config;
  const [records, setRecords] = useState([]);
  const [loading, setLoading] = useState(false);

  // åŠ è½½è®°å½•åˆ—è¡¨
  const loadRecords = async () => {
    try {
      setLoading(true);
      const result = await api.getFilterRows({
        worksheetId,
        viewId,
        pageSize: 100,
        pageIndex: 1
      });
      setRecords(result.data || []);
    } catch (error) {
      console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
    } finally {
      setLoading(false);
    }
  };

  // æ‰“å¼€è®°å½•è¯¦æƒ…
  const handleRecordClick = async (recordId) => {
    try {
      const result = await utils.openRecordInfo({
        appId,
        worksheetId,
        viewId,
        recordId
      });

      // è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨
      if (result?.action === 'update' || result?.action === 'delete') {
        loadRecords(); // åˆ·æ–°æ•°æ®
      }
    } catch (error) {
      console.error('æ‰“å¼€è®°å½•è¯¦æƒ…å¤±è´¥:', error);
    }
  };

  // åˆå§‹åŠ è½½
  useEffect(() => {
    loadRecords();
  }, []);

  return (
    <div>
      {loading ? (
        <div>åŠ è½½ä¸­...</div>
      ) : (
        <div>
          {records.map(record => (
            <div
              key={record.rowid}
              onClick={() => handleRecordClick(record.rowid)}
              style={{ cursor: 'pointer' }}
            >
              {record.title}
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
```

**æ€§èƒ½ä¼˜åŒ–å»ºè®®:**

```javascript
// 1. ä½¿ç”¨ useCallback é¿å…é‡å¤åˆ›å»ºå‡½æ•°
const handleRecordClick = useCallback(async (recordId) => {
  const result = await utils.openRecordInfo({
    appId, worksheetId, viewId, recordId
  });
  if (result?.action === 'update' || result?.action === 'delete') {
    loadRecords();
  }
}, [appId, worksheetId, viewId]);

// 2. åªåœ¨éœ€è¦æ—¶åˆ·æ–°
const handleRecordClick = async (recordId) => {
  const result = await utils.openRecordInfo({
    appId, worksheetId, viewId, recordId
  });

  // æ ¹æ®å…·ä½“æ“ä½œå†³å®šæ˜¯å¦åˆ·æ–°
  if (result?.action === 'update') {
    // å±€éƒ¨æ›´æ–°(æ€§èƒ½æ›´å¥½)
    setRecords(prev =>
      prev.map(r => r.rowid === recordId ? result.value : r)
    );
  } else if (result?.action === 'delete') {
    // ä»åˆ—è¡¨ä¸­ç§»é™¤
    setRecords(prev => prev.filter(r => r.rowid !== recordId));
  }
};
```

#### 4.2 æ‰“å¼€æ–°å»ºè®°å½•çª—å£

```javascript
utils.openNewRecord({
  appId,
  worksheetId
}).then(newRecord => {
  if (newRecord) {
    addLocalRecord(newRecord);
  }
});
```

#### 4.3 é€‰æ‹©ç”¨æˆ·

```javascript
const users = await utils.selectUsers({
  projectId: "orgId1",
  unique: false  // æ˜¯å¦å•é€‰
});
```

#### 4.4 é€‰æ‹©éƒ¨é—¨

```javascript
const departments = await utils.selectDepartments({
  projectId: "orgId1",
  unique: false
});
```

#### 4.5 é€‰æ‹©ä½ç½®

```javascript
const location = await utils.selectLocation({
  distance: 1000,
  defaultPosition: { lat: 39.915, lng: 116.404 },
  multiple: false
});
```

#### 4.6 é€‰æ‹©è®°å½•

```javascript
const records = await utils.selectRecord({
  projectId: "orgId1",
  relateSheetId: "worksheetId1",
  multiple: true
});
```

### 5. äº‹ä»¶ç›‘å¬

#### 5.1 ç­›é€‰æ¡ä»¶å˜æ›´äº‹ä»¶

```javascript
import { md_emitter } from "mdye";

useEffect(() => {
  const handleFiltersUpdate = (newFilters) => {
    console.log('ç­›é€‰æ¡ä»¶å·²æ›´æ–°:', newFilters);
    // é‡æ–°è·å–æ•°æ®
  };

  md_emitter.addListener('filters-update', handleFiltersUpdate);

  return () => {
    md_emitter.removeListener('filters-update', handleFiltersUpdate);
  };
}, []);
```

#### 5.2 æ–°å¢è®°å½•äº‹ä»¶

```javascript
useEffect(() => {
  const handleNewRecord = (newRecord) => {
    console.log('æ–°å¢è®°å½•:', newRecord);
    setRecords(prev => [...prev, newRecord]);
  };

  md_emitter.addListener('new-record', handleNewRecord);

  return () => {
    md_emitter.removeListener('new-record', handleNewRecord);
  };
}, []);
```

## ç‰¹æ®Šå­—æ®µç±»å‹å¤„ç†

### âš ï¸ é‡è¦æç¤º:å­—æ®µç±»å‹ç¼–å·

**æ˜é“äº‘å­—æ®µç±»å‹ç¼–å·ä¸æ–‡æ¡£ä¸­çš„æšä¸¾å€¼ä¸å®Œå…¨ä¸€è‡´,å¼€å‘æ—¶åŠ¡å¿…æ³¨æ„:**

æ ¹æ®æ˜é“äº‘ API V3 ç‰ˆæœ¬çš„å®é™…å­—æ®µç±»å‹å®šä¹‰:
- **Type 9** = å•é€‰ (SingleSelect) âš ï¸ æ³¨æ„ä¸æ˜¯ type 11
- **Type 10** = å¤šé€‰ (MultipleSelect)
- **Type 11** = ä¸‹æ‹‰ (Dropdown)

### å®Œæ•´å­—æ®µç±»å‹å¯¹ç…§è¡¨(V3 å®ç”¨ç‰ˆ)

| ç±»å‹ç¼–å· | æšä¸¾åç§° | å­—æ®µç±»å‹ | API åˆ›å»º | API è¿”å› |
|---------|---------|---------|---------|---------|
| 2 | Text | æ–‡æœ¬æ¡† | âœ… | âœ… |
| 3 | PhoneNumber | æ‰‹æœº | âŒ | âœ… |
| 4 | LandlinePhone | åº§æœº | âŒ | âœ… |
| 5 | Email | é‚®ç®± | âŒ | âœ… |
| 6 | Number | æ•°å€¼ | âœ… | âœ… |
| 7 | Certificate | è¯ä»¶ | âŒ | âœ… |
| 8 | Currency | é‡‘é¢ | âŒ | âœ… |
| **9** | **SingleSelect** | **å•é€‰** | âœ… | âœ… |
| 10 | MultipleSelect | å¤šé€‰ | âœ… | âœ… |
| 11 | Dropdown | ä¸‹æ‹‰ | âŒ | âœ… |
| 14 | Attachment | é™„ä»¶ | âœ… | âœ… |
| 15 | Date | æ—¥æœŸ | âœ… | âœ… |
| 16 | DateTime | æ—¶é—´ | âœ… | âœ… |
| 19/23/24 | Region | åœ°åŒº | âŒ | âœ… |
| 21 | DynamicLink | è‡ªç”±é“¾æ¥ | âŒ | âœ… |
| 22 | Divider | åˆ†æ®µ | âŒ | âŒ |
| 25 | AmountInWords | å¤§å†™é‡‘é¢ | âŒ | âœ… |
| 26 | Collaborator | æˆå‘˜ | âœ… | âœ… |
| 27 | Department | éƒ¨é—¨ | âŒ | âœ… |
| 28 | Rating | ç­‰çº§ | âŒ | âœ… |
| 29 | Relation | è¿æ¥ä»–è¡¨ | âœ… | âœ… |
| 30 | Lookup | ä»–è¡¨å­—æ®µ | âŒ | âœ… |
| 31 | Formula | å…¬å¼ | âŒ | âœ… |
| 32 | Concatenate | æ–‡æœ¬æ‹¼æ¥ | âŒ | âœ… |
| 33 | AutoNumber | è‡ªåŠ¨ç¼–å· | âŒ | âœ… |
| 34 | SubTable | å­è¡¨ | âŒ | âœ… |
| 35 | CascadingSelect | çº§è”é€‰æ‹© | âŒ | âœ… |
| 36 | Checkbox | æ£€æŸ¥æ¡† | âŒ | âœ… |
| 37 | Rollup | æ±‡æ€» | âŒ | âœ… |
| 38 | DateFormula | å…¬å¼(æ—¥æœŸ) | âŒ | âœ… |
| 39 | CodeScan | æ‰«ç  | âŒ | âœ… |
| 40 | Location | å®šä½ | âŒ | âœ… |
| 41 | RichText | å¯Œæ–‡æœ¬ | âŒ | âœ… |
| 42 | Signature | ç­¾å | âŒ | âœ… |
| 43 | OCR | æ–‡å­—è¯†åˆ« | âŒ | âœ… |
| 44 | Role | è§’è‰² | âŒ | âœ… |
| 45 | Embed | åµŒå…¥ | âŒ | âŒ |
| 46 | Time | æ—¶é—´ | âœ… | âœ… |
| 47 | Barcode | æ¡ç  | âŒ | âœ… |
| 48 | OrgRole | ç»„ç»‡è§’è‰² | âŒ | âœ… |

### å¸¸è§é”™è¯¯ç¤ºä¾‹

âŒ **é”™è¯¯å†™æ³•:**
```javascript
// åªæŸ¥æ‰¾ type 10 å’Œ 11,ä¼šé—æ¼ type 9 çš„å•é€‰å­—æ®µ
const selectField = controls?.find(ctrl =>
  ctrl.controlName?.includes('çŠ¶æ€') && (ctrl.type === 10 || ctrl.type === 11)
);
```

âœ… **æ­£ç¡®å†™æ³•:**
```javascript
// åŒ…å« type 9, 10, 11 æ‰€æœ‰é€‰é¡¹å­—æ®µç±»å‹
const selectField = controls?.find(ctrl =>
  ctrl.controlName?.includes('çŠ¶æ€') && (ctrl.type === 9 || ctrl.type === 10 || ctrl.type === 11)
);
```

### å­—æ®µè§£æå‡½æ•°

#### å•é€‰å­—æ®µ

```javascript
function parseSingleSelect(value, control) {
  try {
    if (!value) return { key: "", text: "" };

    const keys = typeof value === 'string'
      ? JSON.parse(value)
      : (Array.isArray(value) ? value : []);

    const selectedKey = keys[0] || "";

    let selectedText = "";
    if (control && control.options) {
      const option = control.options.find(opt => opt.key === selectedKey);
      selectedText = option ? option.value : "";
    }

    return { key: selectedKey, text: selectedText };
  } catch (err) {
    console.error("è§£æå•é€‰å­—æ®µå¤±è´¥:", err);
    return { key: "", text: "" };
  }
}
```

#### å¤šé€‰å­—æ®µ

```javascript
function parseMultiSelect(value, control) {
  try {
    if (!value) return [];

    const keys = typeof value === 'string'
      ? JSON.parse(value)
      : (Array.isArray(value) ? value : []);

    const result = [];
    if (control && control.options) {
      keys.forEach(key => {
        const option = control.options.find(opt => opt.key === key);
        if (option) {
          result.push({ key: key, text: option.value });
        }
      });
    }

    return result;
  } catch (err) {
    console.error("è§£æå¤šé€‰å­—æ®µå¤±è´¥:", err);
    return [];
  }
}
```

#### æˆå‘˜å­—æ®µ

```javascript
function parseMembers(value) {
  try {
    if (!value) return [];
    return typeof value === 'string' ? JSON.parse(value) : value;
  } catch (err) {
    return [];
  }
}
```

#### é™„ä»¶å­—æ®µ

```javascript
function parseAttachments(value) {
  try {
    if (!value) return [];
    return typeof value === 'string' ? JSON.parse(value) : value;
  } catch (err) {
    return [];
  }
}
```

#### å®šä½å­—æ®µ

```javascript
function parseLocation(value) {
  try {
    if (!value) return { title: "", address: "", x: 0, y: 0 };
    return typeof value === 'string' ? JSON.parse(value) : value;
  } catch (err) {
    return { title: "", address: "", x: 0, y: 0 };
  }
}
```

#### å…³è”è®°å½•å­—æ®µï¼ˆâš ï¸ é‡è¦ï¼ï¼‰

**å…³è”å­—æ®µ (type 29) çš„ç‰¹æ®Šå¤„ç†è§„åˆ™:**

å…³è”å­—æ®µæ ¹æ® `enumDefault` æˆ– `subType` å±æ€§åˆ†ä¸ºä¸¤ç§ç±»å‹,è¿”å›æ•°æ®æ ¼å¼å®Œå…¨ä¸åŒ:

1. **å•æ¡å…³è”** (enumDefault=1 æˆ– subType=1)
   - è¿”å›æ ¼å¼: JSON æ•°ç»„å­—ç¬¦ä¸²
   - ç¤ºä¾‹: `"[{\"sid\":\"...\",\"name\":\"å®¢æˆ·åç§°\",\"sourcevalue\":\"...\"}]"`
   - å¤„ç†æ–¹å¼: ç›´æ¥è§£æ JSON å­—ç¬¦ä¸²å³å¯

2. **å¤šæ¡å…³è”** (enumDefault=2 æˆ– subType=2)
   - è¿”å›æ ¼å¼: æ•°å­—(è¡¨ç¤ºå…³è”è®°å½•çš„æ•°é‡)
   - ç¤ºä¾‹: `2` (è¡¨ç¤ºå…³è”äº† 2 æ¡è®°å½•)
   - å¤„ç†æ–¹å¼: **å¿…é¡»è°ƒç”¨ `getRowRelationRows` API** æ‰èƒ½è·å–å®é™…æ•°æ®

**å®Œæ•´å¤„ç†ç¤ºä¾‹:**

```javascript
// 1. åˆ¤æ–­æ˜¯å¦ä¸ºå¤šæ¡å…³è”
function isMultipleRelation(value) {
  return typeof value === 'number' || (!isNaN(value) && value !== '');
}

// 2. è§£æå•æ¡å…³è”æ•°æ®
function parseRelationData(value) {
  try {
    if (!value) return [];

    const relations = typeof value === 'string' ? JSON.parse(value) : value;
    if (!Array.isArray(relations)) return [];

    return relations.map(item => {
      let sourceValue = {};
      if (item.sourcevalue) {
        try {
          sourceValue = typeof item.sourcevalue === 'string'
            ? JSON.parse(item.sourcevalue)
            : item.sourcevalue;
        } catch (e) {
          console.error("è§£æsourcevalueå¤±è´¥:", e);
        }
      }

      return {
        sid: item.sid || '',
        name: item.name || '',
        rowid: sourceValue.rowid || '',
        ...item
      };
    });
  } catch (err) {
    console.error("è§£æå…³è”è®°å½•å­—æ®µå¤±è´¥:", err);
    return [];
  }
}

// 3. å®Œæ•´ä½¿ç”¨ç¤ºä¾‹ï¼ˆåŒ…å«å•æ¡å’Œå¤šæ¡å¤„ç†ï¼‰
async function loadOrdersWithProducts() {
  const result = await api.getFilterRows({
    worksheetId,
    viewId,
    pageSize: 1000,
    pageIndex: 1
  });

  // ä½¿ç”¨ Promise.all å¹¶è¡Œå¤„ç†æ‰€æœ‰è®¢å•
  const ordersData = await Promise.all(
    result.data.map(async (row) => {
      // è·å–å…³è”äº§å“å­—æ®µå€¼
      const productsValue = row['relationFieldId'];
      let products = [];

      // åˆ¤æ–­æ˜¯å•æ¡è¿˜æ˜¯å¤šæ¡å…³è”
      if (isMultipleRelation(productsValue)) {
        // å¤šæ¡å…³è”:è°ƒç”¨ API è·å–è¯¦æƒ…
        try {
          const relationResult = await api.getRowRelationRows({
            worksheetId,
            controlId: 'relationFieldId',  // å…³è”å­—æ®µID
            rowId: row.rowid,
            pageSize: 100,
            pageIndex: 1
          });

          if (relationResult && relationResult.data) {
            products = relationResult.data.map(item => ({
              name: item['productNameFieldId'],    // äº§å“åç§°å­—æ®µID
              code: item['productCodeFieldId'],    // äº§å“ç¼–ç å­—æ®µID
              price: item['productPriceFieldId'],  // äº§å“å•ä»·å­—æ®µID
              rowid: item.rowid
            }));
          }
        } catch (error) {
          console.error('è·å–å¤šæ¡å…³è”å¤±è´¥:', error);
        }
      } else {
        // å•æ¡å…³è”:ç›´æ¥è§£æ
        products = parseRelationData(productsValue);
      }

      return {
        id: row.rowid,
        products: products,
        productsCount: isMultipleRelation(productsValue)
          ? Number(productsValue)
          : products.length
      };
    })
  );

  return ordersData;
}
```

**å­—æ®µé…ç½®ç¤ºä¾‹:**

```javascript
// åœ¨ config.controls ä¸­æŸ¥çœ‹å…³è”å­—æ®µé…ç½®
const relationControl = controls.find(ctrl => ctrl.controlId === 'relationFieldId');

// å•æ¡å…³è”é…ç½®
{
  "controlId": "692ed1d0f34d7ea4df717c67",
  "type": 29,
  "controlName": "å…³è”å®¢æˆ·",
  "enumDefault": 1,  // æˆ– subType: 1
  // ... å…¶ä»–å±æ€§
}

// å¤šæ¡å…³è”é…ç½®
{
  "controlId": "692ed1d0f34d7ea4df717c6e",
  "type": 29,
  "controlName": "å…³è”äº§å“",
  "enumDefault": 2,  // æˆ– subType: 2
  // ... å…¶ä»–å±æ€§
}
```

### è‡ªåŠ¨è·å–å­—æ®µå€¼çš„å·¥å…·å‡½æ•°

```javascript
function getFieldValue(fieldId, record, controls) {
  if (!fieldId || !record) return null;

  const rawValue = record[fieldId];
  if (rawValue === undefined) return null;

  const control = controls.find(ctrl => ctrl.controlId === fieldId);
  if (!control) return rawValue;

  const fieldType = getFieldTypeByControlType(control.type);

  switch (fieldType) {
    case 'text':
    case 'email':
    case 'phone':
      return rawValue;

    case 'number':
      return parseFloat(rawValue) || 0;

    case 'select':
      return parseSingleSelect(rawValue, control);

    case 'multiselect':
      return parseMultiSelect(rawValue, control);

    case 'user':
      return parseMembers(rawValue);

    case 'department':
      return parseDepartments(rawValue);

    case 'attachment':
      return parseAttachments(rawValue);

    case 'location':
      return parseLocation(rawValue);

    case 'boolean':
      return rawValue === "1" || rawValue === 1 || rawValue === true;

    case 'relation':
      return parseRelationData(rawValue);

    default:
      return rawValue;
  }
}

function getFieldTypeByControlType(controlType) {
  const typeMap = {
    2: 'text',           // æ–‡æœ¬æ¡†
    3: 'phone',          // æ‰‹æœº
    4: 'phone',          // åº§æœº
    5: 'email',          // é‚®ç®±
    6: 'number',         // æ•°å€¼
    7: 'certificate',    // è¯ä»¶
    8: 'number',         // é‡‘é¢
    9: 'select',         // å•é€‰ âš ï¸ é‡è¦:type 9 æ˜¯å•é€‰
    10: 'multiselect',   // å¤šé€‰
    11: 'select',        // ä¸‹æ‹‰
    14: 'attachment',    // é™„ä»¶
    15: 'date',          // æ—¥æœŸ
    16: 'datetime',      // æ—¶é—´
    19: 'region',        // åœ°åŒº
    23: 'region',        // åœ°åŒº
    24: 'region',        // åœ°åŒº
    26: 'user',          // æˆå‘˜
    27: 'department',    // éƒ¨é—¨
    28: 'rating',        // ç­‰çº§
    29: 'relation',      // è¿æ¥ä»–è¡¨
    36: 'boolean',       // æ£€æŸ¥æ¡†
    40: 'location',      // å®šä½
    41: 'richtext',      // å¯Œæ–‡æœ¬
    42: 'signature',     // ç­¾å
    46: 'time',          // æ—¶é—´
    48: 'role',          // ç»„ç»‡è§’è‰²
  };
  return typeMap[controlType] || 'unknown';
}
```

## mdye å‘½ä»¤è¡Œå·¥å…·

### åŸºæœ¬å‘½ä»¤

```bash
# æŸ¥çœ‹ç‰ˆæœ¬
mdye --version

# æˆæƒç™»å½•
mdye auth

# åˆå§‹åŒ–é¡¹ç›®
mdye init view --id <id> --template <template-name>

# å¯åŠ¨å¼€å‘
mdye start

# æ„å»ºé¡¹ç›®
mdye build

# æäº¤æ’ä»¶
mdye push -m "æäº¤è¯´æ˜"

# æŸ¥çœ‹å½“å‰ç”¨æˆ·
mdye whoami

# æ³¨é”€
mdye logout

# åŒæ­¥æ’ä»¶å‚æ•°é…ç½®
mdye sync-params -f <file-path>
```

### æ’ä»¶å‘å¸ƒæµç¨‹ï¼ˆé‡è¦ï¼ï¼‰

æ’ä»¶å¼€å‘å®Œæˆåï¼Œéœ€è¦æŒ‰ä»¥ä¸‹æ­¥éª¤æäº¤å‘å¸ƒåˆ°æ˜é“äº‘å¹³å°ã€‚å‘å¸ƒæˆåŠŸåï¼Œæœ¬æ’ä»¶åœ¨ç»„ç»‡ä¸‹æ‰€æœ‰åº”ç”¨å‡å¯ä½¿ç”¨ã€‚

#### ç¬¬1æ­¥ï¼šæ„å»ºé¡¹ç›®

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°†æœ¬åœ°é¡¹ç›®æ‰“åŒ…ï¼š

```bash
cd your_plugin_project
mdye build
```

**æ„å»ºè¿‡ç¨‹è¯´æ˜ï¼š**
- Webpack ä¼šç¼–è¯‘å¹¶æ‰“åŒ…æ‰€æœ‰æºä»£ç 
- ç”Ÿæˆä¼˜åŒ–åçš„ `bundle.js` æ–‡ä»¶
- é€šå¸¸éœ€è¦ 1-2 ç§’å®Œæˆç¼–è¯‘
- æˆåŠŸåä¼šæ˜¾ç¤º "æ„å»ºä»£ç å®Œæˆ" å’Œ bundle æ–‡ä»¶å¤§å°

**æ„å»ºè¾“å‡ºç¤ºä¾‹ï¼š**
```
[21:20:33] å¼€å§‹æ„å»ºä»£ç 
â„¹ Compiling Webpack
âœ” Webpack: Compiled successfully in 1.94s
asset bundle.js 228 KiB [emitted] [minimized] (name: main)
webpack 5.98.0 compiled successfully in 1947 ms
[21:20:35] æ„å»ºä»£ç å®Œæˆ
```

#### ç¬¬2æ­¥ï¼šæäº¤å¹¶å‘å¸ƒ

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°†æœ¬åœ°é¡¹ç›®æäº¤å¹¶æ¨é€åˆ°çº¿ä¸Šå¾…å‘å¸ƒæ’ä»¶åˆ—è¡¨ï¼š

```bash
mdye push -m "æäº¤è¯´æ˜"
```

**æäº¤è¯´æ˜ç¼–å†™å»ºè®®ï¼š**

å»ºè®®åœ¨æäº¤ä¿¡æ¯ä¸­åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
1. **åŠŸèƒ½ç‰¹æ€§**ï¼šåˆ—å‡ºæ’ä»¶çš„ä¸»è¦åŠŸèƒ½
2. **æŠ€æœ¯å®ç°**ï¼šè¯´æ˜å…³é”®æŠ€æœ¯ç‚¹å’Œä¼˜åŒ–
3. **ç‰ˆæœ¬è¯´æ˜**ï¼šé¦–æ¬¡å‘å¸ƒ/åŠŸèƒ½æ›´æ–°/Bugä¿®å¤

**å®Œæ•´ç¤ºä¾‹ï¼š**

```bash
mdye push -m "è®¢å•çŠ¶æ€è§†å›¾æ’ä»¶é¦–æ¬¡å‘å¸ƒ

åŠŸèƒ½ç‰¹æ€§:
- æŒ‰è®¢å•çŠ¶æ€åˆ†ç±»å±•ç¤º(å¾…ä»˜æ¬¾/å·²ä»˜æ¬¾/å·²å‘è´§/å·²å®Œæˆ/å·²å–æ¶ˆ)
- å®Œæ•´è®¢å•ä¿¡æ¯å±•ç¤º(è®¢å•ç¼–å·/å®¢æˆ·/è”ç³»äºº/æ—¥æœŸ/é‡‘é¢/è´Ÿè´£äºº)
- å¤šæ¡å…³è”äº§å“ä¿¡æ¯å±•ç¤º(äº§å“åç§°/ç¼–å·/åˆ†ç±»/å•ä»·)
- ç‚¹å‡»è®¢å•å¡ç‰‡æ‰“å¼€åŸç”Ÿè¡Œè®°å½•å¼¹çª—
- æ”¯æŒç¼–è¾‘/åˆ é™¤è®¢å•å¹¶è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨
- å“åº”å¼ç½‘æ ¼å¸ƒå±€å’Œæµç•…åŠ¨ç”»æ•ˆæœ

æŠ€æœ¯å®ç°:
- æ­£ç¡®å¤„ç†å•é€‰å­—æ®µ(type 9)å’Œå…³è”è®°å½•å­—æ®µ(type 29)
- ä½¿ç”¨ getRowRelationRows API å¤„ç†å¤šæ¡å…³è”
- ä½¿ç”¨ utils.openRecordInfo å®ç°åŸç”Ÿäº¤äº’
- Promise.all å¹¶è¡ŒåŠ è½½æå‡æ€§èƒ½"
```

#### ç¬¬3æ­¥ï¼šç™»å½•è®¤è¯

æäº¤æ—¶éœ€è¦ç™»å½•è´¦æˆ·ï¼ŒæŒ‰æç¤ºè¾“å…¥ï¼š
- ç”¨æˆ·åï¼ˆæ‰‹æœºå·æˆ–é‚®ç®±åœ°å€ï¼‰
- å¯†ç 

å¦‚æœå·²ç™»å½•ï¼Œå¯ä»¥é€šè¿‡ `mdye whoami` æŸ¥çœ‹å½“å‰ç™»å½•ç”¨æˆ·ã€‚

#### ç¬¬4æ­¥ï¼šç¡®è®¤å‘å¸ƒæˆåŠŸ

å‘å¸ƒæˆåŠŸåä¼šæ˜¾ç¤ºæ’ä»¶ä¿¡æ¯ï¼š

```
[21:20:54] æ–‡ä»¶ä¸Šä¼ æˆåŠŸ
[21:20:55] pushæˆåŠŸ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ---- æ’ä»¶ä¿¡æ¯ ----                                       â”‚
â”‚                                                           â”‚
â”‚  æ’ä»¶åç§°: è‡ªå®šä¹‰è§†å›¾                                     â”‚
â”‚  è§†å›¾åç§°: è‡ªå®šä¹‰è§†å›¾                                     â”‚
â”‚  è§†å›¾åœ°å€: https://www.mingdao.com/worksheet/...         â”‚
â”‚  æäº¤ä¿¡æ¯: è®¢å•çŠ¶æ€è§†å›¾æ’ä»¶é¦–æ¬¡å‘å¸ƒ                       â”‚
â”‚  æäº¤äºº: ç”¨æˆ·å                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å‘å¸ƒåçš„çŠ¶æ€

âœ… **æ’ä»¶å·²å‘å¸ƒ** - å¯ä»¥åœ¨ç»„ç»‡å†…æ‰€æœ‰åº”ç”¨ä¸­ä½¿ç”¨
âœ… **è§†å›¾åœ°å€** - å¯ä»¥é€šè¿‡è¿”å›çš„ URL ç›´æ¥è®¿é—®æ’ä»¶
âœ… **ç»„ç»‡å…±äº«** - ç»„ç»‡å†…å…¶ä»–æˆå‘˜å¯ä»¥ä½¿ç”¨è¯¥æ’ä»¶

#### å¸¸è§é—®é¢˜

**é—®é¢˜1: æ„å»ºå¤±è´¥**
- æ£€æŸ¥ä»£ç è¯­æ³•é”™è¯¯
- ç¡®ä¿æ‰€æœ‰ä¾èµ–å·²æ­£ç¡®å®‰è£… (`npm install`)
- æŸ¥çœ‹é”™è¯¯æ—¥å¿—å®šä½é—®é¢˜

**é—®é¢˜2: æ¨é€å¤±è´¥**
- ç¡®è®¤å·²ç™»å½•ï¼š`mdye whoami`
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- éªŒè¯è´¦å·æƒé™æ˜¯å¦æ”¯æŒæ’ä»¶å¼€å‘

**é—®é¢˜3: ç™»å½•è¶…æ—¶**
- é‡æ–°ç™»å½•ï¼š`mdye auth`
- è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·/é‚®ç®±å’Œå¯†ç 

### æœ¬åœ°é¡¹ç›®ç»“æ„

```
plugin_project/
â”œâ”€â”€ .config/          # é…ç½®æ–‡ä»¶ç›®å½•
â”œâ”€â”€ src/              # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ components/   # ç»„ä»¶ç›®å½•
â”‚   â”œâ”€â”€ utils/        # å·¥å…·å‡½æ•°ç›®å½•
â”‚   â”œâ”€â”€ App.js        # ä¸»åº”ç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ index.js      # å…¥å£æ–‡ä»¶
â”‚   â””â”€â”€ style.less    # æ ·å¼æ–‡ä»¶
â”œâ”€â”€ mdye.json         # æ’ä»¶é…ç½®æ–‡ä»¶
â””â”€â”€ package.json      # é¡¹ç›®ä¾èµ–é…ç½®
```

## æœ€ä½³å®è·µ

### 1. é¡¹ç›®ç»„ç»‡
- ä¿æŒé¡¹ç›®ç»“æ„æ¸…æ™°
- åˆç†åˆ’åˆ†ç»„ä»¶å’Œæ¨¡å—
- ä½¿ç”¨æœ‰æ„ä¹‰çš„æ–‡ä»¶å‘½å

### 2. ä»£ç è´¨é‡
- éµå¾ª React æœ€ä½³å®è·µ
- ä½¿ç”¨ ESLint å’Œ Prettier
- ç¼–å†™æ¸…æ™°çš„æ³¨é‡Šå’Œæ–‡æ¡£

### 3. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨ React.memo ä¼˜åŒ–æ¸²æŸ“
- é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
- ä¼˜åŒ–çŠ¶æ€ç®¡ç†
- ä½¿ç”¨ä»£ç åˆ†å‰²

### 4. å®‰å…¨æ³¨æ„äº‹é¡¹
- é¿å…ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
- ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†é…ç½®
- éªŒè¯ç”¨æˆ·è¾“å…¥
- é˜²æ­¢ XSS æ”»å‡»

## å¸¸è§é—®é¢˜è§£å†³

### é—®é¢˜ 1ï¼šé€‰é¡¹å­—æ®µæ˜¾ç¤º key è€Œä¸æ˜¯æ–‡æœ¬

**é—®é¢˜æè¿°:** å•é€‰æˆ–å¤šé€‰å­—æ®µæ˜¾ç¤ºçš„æ˜¯ UUID æ ¼å¼çš„ key (å¦‚ `42ad38bf-d3e6-441f-a960-670e704abe4a`),è€Œä¸æ˜¯é€‰é¡¹çš„æ˜¾ç¤ºæ–‡æœ¬ã€‚

**åŸå› åˆ†æ:**
1. æ˜é“äº‘é€‰é¡¹å­—æ®µè¿”å›çš„åŸå§‹å€¼æ˜¯ JSON æ ¼å¼çš„ key æ•°ç»„,å¦‚ `"[\"42ad38bf-d3e6-441f-a960-670e704abe4a\"]"`
2. éœ€è¦ä» `config.controls` ä¸­æ‰¾åˆ°å¯¹åº”å­—æ®µçš„ `options`,ç„¶åæ ¹æ® key åŒ¹é…å‡º value

**è§£å†³æ–¹æ¡ˆ:**
```javascript
// 1. è·å–å­—æ®µæ§ä»¶å®šä¹‰(åŒ…å«options)
const control = config.controls.find(ctrl => ctrl.controlId === fieldId);

// 2. è§£æé€‰é¡¹å­—æ®µ
function parseSingleSelect(value, control) {
  try {
    if (!value) return { key: "", text: "" };

    // è§£æ JSON å­—ç¬¦ä¸²å¾—åˆ° key æ•°ç»„
    let keys = [];
    if (typeof value === 'string') {
      try {
        keys = JSON.parse(value); // ["42ad38bf-..."]
      } catch {
        keys = [value];
      }
    } else if (Array.isArray(value)) {
      keys = value;
    }

    const selectedKey = keys[0] || "";

    // ä» options ä¸­æŸ¥æ‰¾å¯¹åº”çš„æ˜¾ç¤ºæ–‡æœ¬
    let selectedText = "";
    if (control && control.options) {
      const option = control.options.find(opt => opt.key === selectedKey);
      selectedText = option ? option.value : selectedKey;
    }

    return { key: selectedKey, text: selectedText };
  } catch (err) {
    console.error("è§£æå•é€‰å­—æ®µå¤±è´¥:", err, value);
    return { key: "", text: "" };
  }
}
```

### é—®é¢˜ 2ï¼šæ‰¾ä¸åˆ°å•é€‰å­—æ®µ

**é—®é¢˜æè¿°:** ä½¿ç”¨ `controls.find()` æŸ¥æ‰¾å•é€‰å­—æ®µæ—¶,è¿”å› `undefined`ã€‚

**åŸå› åˆ†æ:**
- å•é€‰å­—æ®µçš„ type æ˜¯ **9** è€Œä¸æ˜¯ 11
- type 10 æ˜¯å¤šé€‰,type 11 æ˜¯ä¸‹æ‹‰
- å¦‚æœåªæ£€æŸ¥ `ctrl.type === 11`,ä¼šé—æ¼ type 9 çš„å•é€‰å­—æ®µ

**è§£å†³æ–¹æ¡ˆ:**
```javascript
// âœ… æ­£ç¡®:åŒ…å«æ‰€æœ‰é€‰é¡¹å­—æ®µç±»å‹
const selectField = controls?.find(ctrl =>
  ctrl.controlName?.includes('çŠ¶æ€') &&
  (ctrl.type === 9 || ctrl.type === 10 || ctrl.type === 11)
);

// âŒ é”™è¯¯:ä¼šé—æ¼ type 9
const selectField = controls?.find(ctrl =>
  ctrl.controlName?.includes('çŠ¶æ€') &&
  (ctrl.type === 10 || ctrl.type === 11)
);
```

### é—®é¢˜ 3ï¼šå¤šæ¡å…³è”å­—æ®µåªæ˜¾ç¤ºæ•°å­—

**é—®é¢˜æè¿°:** å…³è”å­—æ®µæ˜¾ç¤ºçš„æ˜¯æ•°å­—(å¦‚ `2`ã€`3`),è€Œä¸æ˜¯å®é™…çš„å…³è”è®°å½•ä¿¡æ¯ã€‚

**åŸå› åˆ†æ:**
1. å¤šæ¡å…³è”å­—æ®µ (enumDefault=2 æˆ– subType=2) è¿”å›çš„åŸå§‹å€¼æ˜¯æ•°å­—,è¡¨ç¤ºå…³è”è®°å½•çš„æ•°é‡
2. ä¸å•æ¡å…³è”ä¸åŒ,å¤šæ¡å…³è”ä¸ä¼šç›´æ¥è¿”å› JSON æ•°ç»„å­—ç¬¦ä¸²
3. å¿…é¡»è°ƒç”¨ `getRowRelationRows` API æ‰èƒ½è·å–å®é™…çš„å…³è”è®°å½•æ•°æ®

**è§£å†³æ–¹æ¡ˆ:**

```javascript
// 1. åˆ¤æ–­æ˜¯å¦ä¸ºå¤šæ¡å…³è”
function isMultipleRelation(value) {
  return typeof value === 'number' || (!isNaN(value) && value !== '');
}

// 2. å¤„ç†å…³è”å­—æ®µ(æ”¯æŒå•æ¡å’Œå¤šæ¡)
async function handleRelationField(worksheetId, controlId, rowId, fieldValue) {
  let relationData = [];

  if (isMultipleRelation(fieldValue)) {
    // å¤šæ¡å…³è”:è°ƒç”¨ API è·å–è¯¦æƒ…
    try {
      const result = await api.getRowRelationRows({
        worksheetId,
        controlId,
        rowId,
        pageSize: 100,
        pageIndex: 1
      });

      if (result && result.data) {
        relationData = result.data.map(item => ({
          rowid: item.rowid,
          name: item['titleFieldId'],  // ä½¿ç”¨å®é™…çš„æ ‡é¢˜å­—æ®µID
          // è§£æå…¶ä»–éœ€è¦çš„å­—æ®µ
        }));
      }
    } catch (error) {
      console.error('è·å–å¤šæ¡å…³è”å¤±è´¥:', error);
    }
  } else {
    // å•æ¡å…³è”:ç›´æ¥è§£æ
    relationData = parseRelationData(fieldValue);
  }

  return relationData;
}

// 3. å®Œæ•´ä½¿ç”¨ç¤ºä¾‹
async function loadRecordsWithRelations() {
  const result = await api.getFilterRows({
    worksheetId,
    viewId,
    pageSize: 100,
    pageIndex: 1
  });

  // ä½¿ç”¨ Promise.all å¹¶è¡Œå¤„ç†
  const records = await Promise.all(
    result.data.map(async (row) => {
      const relationValue = row['relationFieldId'];

      const relations = await handleRelationField(
        worksheetId,
        'relationFieldId',
        row.rowid,
        relationValue
      );

      return {
        ...row,
        relations: relations
      };
    })
  );

  return records;
}
```

**å¦‚ä½•åˆ¤æ–­å­—æ®µæ˜¯å•æ¡è¿˜æ˜¯å¤šæ¡å…³è”:**

```javascript
// æ–¹æ³•1: æŸ¥çœ‹å­—æ®µé…ç½®
const control = config.controls.find(ctrl => ctrl.controlId === 'relationFieldId');
if (control) {
  const isSingle = control.enumDefault === 1 || control.subType === 1;
  const isMultiple = control.enumDefault === 2 || control.subType === 2;
  console.log('å•æ¡å…³è”:', isSingle, 'å¤šæ¡å…³è”:', isMultiple);
}

// æ–¹æ³•2: æ ¹æ®è¿”å›å€¼ç±»å‹åˆ¤æ–­
const value = row['relationFieldId'];
if (typeof value === 'number' || !isNaN(value)) {
  console.log('è¿™æ˜¯å¤šæ¡å…³è”,éœ€è¦è°ƒç”¨ getRowRelationRows');
} else if (typeof value === 'string') {
  console.log('è¿™æ˜¯å•æ¡å…³è”,å¯ä»¥ç›´æ¥è§£æ JSON');
}
```

### é—®é¢˜ 4ï¼šnpm å®‰è£…å¤±è´¥
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æ¸…ç† npm ç¼“å­˜ï¼š`npm cache clean --force`
- ä½¿ç”¨æ·˜å®é•œåƒï¼š`npm config set registry https://registry.npmmirror.com`

### é—®é¢˜ 2ï¼šmdye å‘½ä»¤ä¸å­˜åœ¨
- é‡æ–°å®‰è£… mdye-cli
- æ£€æŸ¥ PATH ç¯å¢ƒå˜é‡
- ä½¿ç”¨ `which mdye` æ£€æŸ¥å®‰è£…ä½ç½®

### é—®é¢˜ 3ï¼šé¡¹ç›®å¯åŠ¨å¤±è´¥
- æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
- æ£€æŸ¥ä¾èµ–æ˜¯å¦å®Œæ•´å®‰è£…
- æŸ¥çœ‹é”™è¯¯æ—¥å¿—ä¿¡æ¯

### é—®é¢˜ 4ï¼šæ’ä»¶ ID å†²çª
- ä½¿ç”¨æ–°çš„å”¯ä¸€åç¼€
- åˆ é™¤æ—§çš„å†²çªé¡¹ç›®
- é‡æ–°åˆå§‹åŒ–é¡¹ç›®

## ğŸ¤– AI åŠ©æ‰‹æ‰§è¡ŒæŒ‡å—

å½“ç”¨æˆ·è¯·æ±‚å¼€å‘æ˜é“äº‘è§†å›¾æ’ä»¶æ—¶,AI å¿…é¡»æŒ‰ç…§ä»¥ä¸‹æµç¨‹æ‰§è¡Œ:

### 1. å‰ç½®ç¯å¢ƒæ£€æŸ¥(å¿…é¡»æ‰§è¡Œ)

**Step 1.1: æ£€æŸ¥ Node.js ç‰ˆæœ¬**

```bash
node --version
```

- âœ… å¦‚æœç‰ˆæœ¬ >= 16.20: ç»§ç»­ä¸‹ä¸€æ­¥
- âŒ å¦‚æœç‰ˆæœ¬ < 16.20 æˆ–æœªå®‰è£…:
  - å‘ŠçŸ¥ç”¨æˆ·éœ€è¦å®‰è£… Node.js 16.20 æˆ–æ›´é«˜ç‰ˆæœ¬
  - æä¾›å®‰è£…é“¾æ¥: https://nodejs.org/
  - ç­‰å¾…ç”¨æˆ·å®‰è£…å®Œæˆåå†ç»§ç»­

**Step 1.2: æ£€æŸ¥ mdye-cli æ˜¯å¦å·²å®‰è£…**

```bash
mdye --version
```

- âœ… å¦‚æœæ˜¾ç¤ºç‰ˆæœ¬å·: mdye-cli å·²å®‰è£…,è·³è¿‡å®‰è£…æ­¥éª¤
- âŒ å¦‚æœå‘½ä»¤ä¸å­˜åœ¨: **è‡ªåŠ¨å¸®ç”¨æˆ·å®‰è£… mdye-cli**

**Step 1.3: è‡ªåŠ¨å®‰è£… mdye-cli(å¦‚æœæœªå®‰è£…)**

**Mac OS ç”¨æˆ·:**
```bash
sudo npm install -g mdye-cli
```

**Windows/Linux ç”¨æˆ·:**
```bash
npm install -g mdye-cli
```

**å®‰è£…åéªŒè¯:**
```bash
mdye --version
```

**å‘ŠçŸ¥ç”¨æˆ·:**
```
âœ… mdye-cli å·¥å…·å·²å®‰è£…

ğŸ“‹ å®‰è£…ä¿¡æ¯:
- å·¥å…·åç§°: mdye-cli
- ç‰ˆæœ¬: [æ˜¾ç¤ºç‰ˆæœ¬å·]
- ç”¨é€”: æ˜é“äº‘è§†å›¾æ’ä»¶å¼€å‘ä¸“ç”¨å‘½ä»¤è¡Œå·¥å…·

ğŸ’¡ ä¸‹ä¸€æ­¥:
- ç°åœ¨å¯ä»¥å¼€å§‹åˆ›å»ºè§†å›¾æ’ä»¶é¡¹ç›®äº†
```

### 2. æ¨¡æ¿é€‰æ‹©(æ ¹æ®éœ€æ±‚è‡ªåŠ¨é€‰æ‹©)

æ ¹æ®ç”¨æˆ·éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ¨¡æ¿:

| ç”¨æˆ·éœ€æ±‚ | æ¨èæ¨¡æ¿ | è¯´æ˜ |
|---------|---------|------|
| ç®€å•å±•ç¤ºã€å­¦ä¹ ç¤ºä¾‹ | `--template React` | React åŸºç¡€æ¨¡æ¿,é€‚åˆå¿«é€Ÿä¸Šæ‰‹ |
| éœ€è¦ UI ç»„ä»¶åº“ | `--template React-Tailwind` | åŒ…å« Tailwind CSS,é€‚åˆå¿«é€Ÿæ„å»ºç•Œé¢ |
| å¤æ‚ä¸šåŠ¡é€»è¾‘ | `--template React` | åŸºç¡€æ¨¡æ¿,å¯è‡ªè¡Œæ·»åŠ éœ€è¦çš„åº“ |
| Vue æŠ€æœ¯æ ˆ | `--template Vue` | Vue æ¨¡æ¿(å¦‚æœå¯ç”¨) |

**é»˜è®¤æ¨è**: `--template React-Tailwind`(é€‚åˆå¤§å¤šæ•°åœºæ™¯)

### 3. é¡¹ç›®åˆå§‹åŒ–(è‡ªåŠ¨æ‰§è¡Œ)

**Step 3.1: è¯¢é—®æˆ–ç”Ÿæˆæ’ä»¶ ID**

- å¦‚æœç”¨æˆ·æä¾›äº†æ’ä»¶ ID: ç›´æ¥ä½¿ç”¨
- å¦‚æœç”¨æˆ·æœªæä¾›: ä½¿ç”¨ç¤ºä¾‹ ID æˆ–è¯¢é—®ç”¨æˆ·

**Step 3.2: åˆå§‹åŒ–é¡¹ç›®**

```bash
mdye init view --id [æ’ä»¶ID] --template React-Tailwind
```

**Step 3.3: è¿›å…¥é¡¹ç›®ç›®å½•å¹¶å®‰è£…ä¾èµ–**

```bash
cd mdye_view_[æ’ä»¶åç¼€]/
npm i
```

**å¦‚æœ npm å®‰è£…å¤±è´¥:**
- å»ºè®®ä½¿ç”¨æ·˜å®é•œåƒ: `npm config set registry https://registry.npmmirror.com`
- æ¸…ç†ç¼“å­˜: `npm cache clean --force`
- é‡æ–°å®‰è£…: `npm i`

### 4. å¯åŠ¨å¼€å‘ç¯å¢ƒ(è‡ªåŠ¨æ‰§è¡Œ)

```bash
mdye start
```

**å¯åŠ¨åå‘ŠçŸ¥ç”¨æˆ·:**
```
âœ… è§†å›¾æ’ä»¶å¼€å‘ç¯å¢ƒå·²å¯åŠ¨ï¼

ğŸ“‹ é¡¹ç›®ä¿¡æ¯:
- é¡¹ç›®ç›®å½•: mdye_view_[æ’ä»¶åç¼€]/
- å¼€å‘æœåŠ¡å™¨: http://localhost:3000/
- è°ƒè¯•åœ°å€: http://localhost:3000/bundle.js

ğŸ’¡ ä¸‹ä¸€æ­¥:
1. å°†è°ƒè¯•åœ°å€ç²˜è´´åˆ°æ˜é“äº‘è§†å›¾é…ç½®çš„å¼€å‘è°ƒè¯•è¾“å…¥æ¡†
2. åœ¨é¡¹ç›®ä¸­ç¼–è¾‘ä»£ç ,æ”¯æŒçƒ­é‡è½½
3. å¼€å‘å®Œæˆåè¿è¡Œ `npm run build` ç”Ÿæˆå‘å¸ƒåŒ…

ğŸ“– å¼€å‘æŒ‡å—:
- ä¸»å…¥å£æ–‡ä»¶: src/index.jsx
- æ ·å¼æ–‡ä»¶: src/styles.less
- API ä½¿ç”¨: å‚è€ƒæŠ€èƒ½æ–‡æ¡£ä¸­çš„ API ä½¿ç”¨æŒ‡å—
```

### 5. å¼€å‘è¿‡ç¨‹ä¸­çš„è¾…åŠ©

**ç”¨æˆ·è¯·æ±‚æ•°æ®æŸ¥è¯¢æ—¶:**
- ä½¿ç”¨ `api.getFilterRows()` è·å–å·¥ä½œè¡¨æ•°æ®
- æ­£ç¡®å¤„ç†å…³è”å­—æ®µ(å‚è€ƒ"å¸¸è§é—®é¢˜"éƒ¨åˆ†)
- å¤„ç†é€‰é¡¹å­—æ®µ(ä½¿ç”¨ key å€¼è€Œé value)

**ç”¨æˆ·è¯·æ±‚æ•°æ®æ“ä½œæ—¶:**
- ä½¿ç”¨ `api.addWorksheetRow()` æ–°å¢è®°å½•
- ä½¿ç”¨ `api.updateWorksheetRow()` æ›´æ–°è®°å½•
- ä½¿ç”¨ `api.deleteWorksheetRows()` åˆ é™¤è®°å½•

**ç”¨æˆ·é‡åˆ°é—®é¢˜æ—¶:**
- å‚è€ƒ"å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"éƒ¨åˆ†
- æä¾›è¯¦ç»†çš„è¯Šæ–­æ­¥éª¤å’Œè§£å†³æ–¹æ¡ˆ

### 6. AI æ‰§è¡ŒåŸåˆ™

- âœ… **ä¸»åŠ¨æ£€æŸ¥**: å¼€å‘å‰å¿…é¡»æ£€æŸ¥ Node.js å’Œ mdye-cli
- âœ… **è‡ªåŠ¨å®‰è£…**: æ£€æµ‹åˆ°å·¥å…·æœªå®‰è£…æ—¶,è‡ªåŠ¨å¸®ç”¨æˆ·å®‰è£…
- âœ… **é€‰æ‹©æ¨¡æ¿**: æ ¹æ®ç”¨æˆ·éœ€æ±‚è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„æ¨¡æ¿
- âœ… **å®Œæ•´æµç¨‹**: ä»ç¯å¢ƒæ£€æŸ¥åˆ°å¯åŠ¨å¼€å‘ç¯å¢ƒ,ä¸€æ°”å‘µæˆ
- âœ… **é”™è¯¯å¤„ç†**: é‡åˆ°é”™è¯¯æ—¶æä¾›è¯¦ç»†è¯Šæ–­å’Œè§£å†³æ–¹æ¡ˆ
- âŒ **ä¸è¦è·³è¿‡**: ä¸è¦è·³è¿‡å‰ç½®ç¯å¢ƒæ£€æŸ¥æ­¥éª¤
- âŒ **ä¸è¦å‡è®¾**: ä¸è¦å‡è®¾ç”¨æˆ·å·²å®‰è£…æ‰€æœ‰å·¥å…·

---

## å‚è€ƒèµ„æº

- æ˜é“äº‘å¼€å‘è€…æ–‡æ¡£
- React å®˜æ–¹æ–‡æ¡£
- Node.js å®˜æ–¹æ–‡æ¡£
- æ˜é“äº‘å¼€å‘è€…ç¤¾åŒº

---

**æ³¨æ„ï¼š** æ­¤æŠ€èƒ½æä¾›çš„æ˜¯å¼€å‘å·¥ä½œæµç¨‹æŒ‡å¯¼å’Œ API ä½¿ç”¨è§„èŒƒï¼Œå®é™…å¼€å‘ä¸­è¯·æ ¹æ®å…·ä½“éœ€æ±‚è°ƒæ•´é…ç½®å’Œä»£ç ã€‚
