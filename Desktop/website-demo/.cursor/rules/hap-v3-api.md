
# HAP V3 æ¥å£ä½¿ç”¨æŠ€èƒ½

æ­¤æŠ€èƒ½æä¾›ä½¿ç”¨æ˜é“äº‘ HAP V3 æ¥å£æ­å»ºé¡µé¢ã€å®æ—¶è·å–æ•°æ®å’Œæ“ä½œæ•°æ®çš„å®Œæ•´æŒ‡å—ã€‚

## å…³äºæ­¤æŠ€èƒ½

æ˜é“äº‘ HAP (High-performance Application Platform) æ˜¯ä¸€ä¸ªè¶…çº§åº”ç”¨å¹³å°,é€šè¿‡è¿™ä¸ªåŸºåº§å¯ä»¥æ­å»ºå¾ˆå¤šåº”ç”¨ã€‚é€šè¿‡ HAP V3 æ¥å£,æ‚¨å¯ä»¥:

1. **åœ¨è‡ªå®šä¹‰è§†å›¾æ’ä»¶ä¸­**è°ƒç”¨ V3 æ¥å£æ“ä½œæ•°æ®
2. **åœ¨ç‹¬ç«‹å‰ç«¯é¡µé¢ä¸­**ä½¿ç”¨ V3 æ¥å£ç¼–æ’ä¸šåŠ¡é€»è¾‘
3. **å®æ—¶è·å–å’Œæ“ä½œ**æ˜é“äº‘åº”ç”¨ä¸­çš„æ•°æ®

## ğŸ¤– AI æ‰§è¡Œæ­¥éª¤ï¼ˆæ€è€ƒ Todo Listï¼‰

**å½“ç”¨æˆ·éœ€è¦ä½¿ç”¨ HAP V3 æ¥å£æ—¶ï¼ŒAI åº”æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ€è€ƒå’Œæ‰§è¡Œï¼š**

### æ­¥éª¤ 1: è¯†åˆ«ä½¿ç”¨åœºæ™¯
- [ ] åˆ¤æ–­ç”¨æˆ·çš„ä½¿ç”¨åœºæ™¯ï¼š
  - åœ¨è‡ªå®šä¹‰è§†å›¾æ’ä»¶ä¸­ä½¿ç”¨ V3 æ¥å£ï¼Ÿ
  - åœ¨ç‹¬ç«‹å‰ç«¯é¡µé¢ä¸­ä½¿ç”¨ V3 æ¥å£ï¼Ÿ
  - éœ€è¦æŸ¥è¯¢ API æ–‡æ¡£ï¼Ÿ

### æ­¥éª¤ 2: è·å–é‰´æƒä¿¡æ¯
- [ ] æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²é…ç½® HAP MCPï¼ˆ`~/.cursor/mcp.json`ï¼‰
- [ ] å¦‚æœæ²¡æœ‰é…ç½®ï¼ŒæŒ‡å¯¼ç”¨æˆ·é…ç½®æˆ–ä»ç”¨æˆ·æä¾›çš„é…ç½®ä¸­æå–
- [ ] ä» MCP é…ç½®ä¸­æå– Appkey å’Œ Sign
- [ ] å‘ŠçŸ¥ç”¨æˆ·å¦‚ä½•åœ¨ä»£ç ä¸­ä½¿ç”¨è¿™äº›é‰´æƒä¿¡æ¯

### æ­¥éª¤ 3: æŸ¥è¯¢ API æ–‡æ¡£ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] å¦‚æœç”¨æˆ·éœ€è¦äº†è§£å¦‚ä½•è°ƒç”¨æŸä¸ªæ¥å£ï¼š
  - [ ] ä½¿ç”¨ Apifox MCP æŸ¥è¯¢ç›¸å…³ API æ–‡æ¡£
  - [ ] å±•ç¤ºæ¥å£å®šä¹‰ã€å‚æ•°ã€è¿”å›å€¼
  - [ ] æä¾›ä»£ç ç¤ºä¾‹

### æ­¥éª¤ 4: å®ç° API è°ƒç”¨
- [ ] æ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„è°ƒç”¨æ–¹å¼ï¼š
  - [ ] è§†å›¾æ’ä»¶ä¸­ï¼šä½¿ç”¨ `mdye` å°è£…çš„ API æˆ–ç›´æ¥è°ƒç”¨
  - [ ] ç‹¬ç«‹é¡µé¢ä¸­ï¼šä½¿ç”¨ fetch/axios è°ƒç”¨ï¼Œå¤„ç† CORS
- [ ] é…ç½®æ­£ç¡®çš„è¯·æ±‚å¤´ï¼ˆAppkeyã€Signï¼‰
- [ ] æ„å»ºè¯·æ±‚å‚æ•°ï¼ˆpayloadã€filter ç­‰ï¼‰
- [ ] å®ç°é”™è¯¯å¤„ç†

### æ­¥éª¤ 5: å¤„ç†æ•°æ®
- [ ] è§£æè¿”å›çš„æ•°æ®ç»“æ„
- [ ] å¤„ç†ç­›é€‰å™¨ï¼ˆfilterï¼‰çš„æ„å»º
- [ ] å¤„ç†é™„ä»¶å­—æ®µï¼ˆå¿…é¡»æœ‰ URLï¼‰
- [ ] å¤„ç†é€‰é¡¹å­—æ®µï¼ˆä½¿ç”¨ key è€Œéæ˜¾ç¤ºæ–‡æœ¬ï¼‰

### æ­¥éª¤ 6: æµ‹è¯•å’Œä¼˜åŒ–
- [ ] ä½¿ç”¨ MCP éªŒè¯æ•°æ®ä¸€è‡´æ€§
- [ ] æµ‹è¯•æ¥å£è°ƒç”¨æ˜¯å¦æ­£å¸¸
- [ ] ä¼˜åŒ–æ€§èƒ½ï¼ˆç¼“å­˜ã€é˜²æŠ–ç­‰ï¼‰

---

## HAP ä½œä¸ºåç«¯æœåŠ¡

**é‡è¦ç†å¿µ**: HAP åº”ç”¨ = å®Œæ•´çš„åç«¯æœåŠ¡

- **å·¥ä½œè¡¨** = æ•°æ®åº“è¡¨
- **å­—æ®µ** = è¡¨å­—æ®µ
- **V3 æ¥å£** = RESTful API
- **HAP MCP** = åº”ç”¨ç»“æ„å’Œæ•°æ®ç®¡ç†å·¥å…·

ç‹¬ç«‹é¡µé¢å¼€å‘æ—¶,HAP åº”ç”¨å……å½“ä¸­åç«¯æœåŠ¡,æä¾›:
- âœ… æ•°æ®å­˜å‚¨(å·¥ä½œè¡¨å³æ•°æ®åº“)
- âœ… ä¸šåŠ¡é€»è¾‘(å­—æ®µå…¬å¼ã€å·¥ä½œæµ)
- âœ… æƒé™ç®¡ç†(è§’è‰²å’Œæƒé™é…ç½®)
- âœ… API æ¥å£(V3 RESTful API)

## ä½¿ç”¨ MCP ç®¡ç†åº”ç”¨

**HAP MCP å¯ä»¥:**
- ğŸ” æŸ¥è¯¢åº”ç”¨ç»“æ„(å·¥ä½œè¡¨ã€å­—æ®µå®šä¹‰)
- ğŸ“ è¯»å–æ•°æ®(æŸ¥è¯¢è®°å½•)
- â• åˆ›å»ºè®°å½•
- âœï¸ æ›´æ–°è®°å½•
- ğŸ—‘ï¸ åˆ é™¤è®°å½•
- âš™ï¸ ç®¡ç†åº”ç”¨ç»“æ„(å¦‚æœ MCP æ”¯æŒ)

**å¼€å‘æµç¨‹:**
1. é€šè¿‡ MCP åˆ†æç°æœ‰åº”ç”¨ç»“æ„
2. è®¾è®¡æ•°æ®æ¨¡å‹å¹¶å¾å¾—ç”¨æˆ·åŒæ„
3. é…ç½® HAP åº”ç”¨(æ‰‹åŠ¨æˆ–é€šè¿‡ MCP)
4. é€šè¿‡ MCP åˆ›å»ºç¤ºä¾‹æ•°æ®
5. é€šè¿‡ MCP è·å–å­—æ®µ ID æ˜ å°„
6. å¼€å‘å‰ç«¯é¡µé¢
7. é€šè¿‡ MCP éªŒè¯æ•°æ®ä¸€è‡´æ€§

**è¯¦ç»†æµç¨‹**: å‚è§ [MCP_WORKFLOW.md](./MCP_WORKFLOW.md) å’Œ [DEVELOPMENT_WORKFLOW.md](./DEVELOPMENT_WORKFLOW.md)

### æ ¸å¿ƒæ¦‚å¿µ

- **åº”ç”¨ (App)**: æ˜é“äº‘ä¸­çš„ä¸€ä¸ªå®Œæ•´åº”ç”¨,ç”±å¤šä¸ªå·¥ä½œè¡¨ç»„æˆ
- **å·¥ä½œè¡¨ (Worksheet)**: ç±»ä¼¼æ•°æ®è¡¨,å­˜å‚¨å…·ä½“çš„ä¸šåŠ¡æ•°æ®
- **è§†å›¾ (View)**: å·¥ä½œè¡¨çš„ä¸åŒå±•ç¤ºæ–¹å¼
- **Appkey & Sign**: åº”ç”¨çº§åˆ«çš„é‰´æƒå¯†é’¥,ç”¨äº API è®¿é—®æ§åˆ¶

## é‰´æƒé…ç½®

### 1. è·å–é‰´æƒå¯†é’¥

æ¯ä¸ªæ˜é“äº‘åº”ç”¨éƒ½æœ‰ä¸“å±çš„ Appkey å’Œ Sign,ç”¨äº V3 æ¥å£é‰´æƒã€‚

**ä» MCP é…ç½®ä¸­è·å–:**

```json
{
  "hap-mcp-MEGA CRM": {
    "url": "https://api.mingdao.com/mcp?HAP-Appkey=881f73bb18ad7b7d&HAP-Sign=NTk4OGRhYzkzMzkxOGMxZWVlZDRlN2ZmMzhkN2JjZDM2ODAwOGVmMTI5NTQwODA3ZGI4NTBmOGMzOTlkNmE4ZA==",
    "type": "sse"
  }
}
```

æå–å‡º:
- **Appkey**: `881f73bb18ad7b7d`
- **Sign**: `NTk4OGRhYzkzMzkxOGMxZWVlZDRlN2ZmMzhkN2JjZDM2ODAwOGVmMTI5NTQwODA3ZGI4NTBmOGMzOTlkNmE4ZA==`

### 2. é…ç½®è¯·æ±‚å¤´

æ‰€æœ‰ V3 æ¥å£è¯·æ±‚éƒ½éœ€è¦åœ¨ HTTP Header ä¸­åŒ…å«é‰´æƒä¿¡æ¯:

```javascript
const headers = {
  'Content-Type': 'application/json',
  'HAP-Appkey': '881f73bb18ad7b7d',
  'HAP-Sign': 'NTk4OGRhYzkzMzkxOGMxZWVlZDRlN2ZmMzhkN2JjZDM2ODAwOGVmMTI5NTQwODA3ZGI4NTBmOGMzOTlkNmE4ZA=='
};
```

### 3. å¤„ç† CORS è·¨åŸŸé—®é¢˜

åœ¨å‰ç«¯é¡µé¢ä¸­è°ƒç”¨ HAP V3 æ¥å£æ—¶,éœ€è¦å¤„ç† CORS è·¨åŸŸ:

**æ–¹æ¡ˆ1: ä½¿ç”¨ä»£ç†æœåŠ¡å™¨**
```javascript
// åœ¨ package.json ä¸­é…ç½®ä»£ç†
{
  "proxy": "https://api.mingdao.com"
}

// è°ƒç”¨æ—¶ä½¿ç”¨ç›¸å¯¹è·¯å¾„
const response = await fetch('/v3/app/worksheets/list', {
  method: 'POST',
  headers: headers,
  body: JSON.stringify(payload)
});
```

**æ–¹æ¡ˆ2: åœ¨æœåŠ¡ç«¯è°ƒç”¨**
```javascript
// Node.js åç«¯ç¤ºä¾‹
const axios = require('axios');

async function getWorksheets(appId) {
  const response = await axios.post(
    'https://api.mingdao.com/v3/app/worksheets/list',
    { appId },
    { headers }
  );
  return response.data;
}
```

## è·å– API æ–‡æ¡£ç»“æ„

ä½¿ç”¨ Apifox MCP Server è·å–å®Œæ•´çš„ API æ–‡æ¡£:

**MCP é…ç½®:**
```json
{
  "HAP-åº”ç”¨APIæ–‡æ¡£": {
    "command": "npx -y apifox-mcp-server@latest --site-id=5442569",
    "args": [],
    "env": {},
    "type": "stdio"
  }
}
```

**æŸ¥è¯¢ç¤ºä¾‹:**
é€šè¿‡ MCP å¯ä»¥æŸ¥è¯¢:
- æ‰€æœ‰å¯ç”¨çš„ API ç«¯ç‚¹
- æ¯ä¸ªæ¥å£çš„è¯·æ±‚å‚æ•°
- å“åº”æ•°æ®ç»“æ„
- ç­›é€‰å™¨ä½¿ç”¨è§„èŒƒ

## å¸¸ç”¨ API æ¥å£

### 1. åº”ç”¨ç®¡ç†

#### è·å–åº”ç”¨ä¿¡æ¯

```javascript
// GET /v3/app
const response = await fetch('https://api.mingdao.com/v3/app', {
  method: 'GET',
  headers: {
    'HAP-Appkey': appkey,
    'HAP-Sign': sign
  }
});

const appInfo = await response.json();
console.log('åº”ç”¨ä¿¡æ¯:', appInfo);
```

**å“åº”æ•°æ®:**
```json
{
  "appId": "693d2fed8474b99be3d3c12e",
  "appName": "MEGA CRM",
  "description": "å®¢æˆ·å…³ç³»ç®¡ç†ç³»ç»Ÿ",
  "iconUrl": "https://...",
  "iconColor": "#2196F3"
}
```

#### è·å–å·¥ä½œè¡¨åˆ—è¡¨

```javascript
// POST /v3/app/worksheets/list
const response = await fetch('https://api.mingdao.com/v3/app/worksheets/list', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'HAP-Appkey': appkey,
    'HAP-Sign': sign
  },
  body: JSON.stringify({
    appId: '693d2fed8474b99be3d3c12e'
  })
});

const { worksheets } = await response.json();
```

**å“åº”æ•°æ®:**
```json
{
  "worksheets": [
    {
      "worksheetId": "69563e5df03728c888c04f05",
      "worksheetName": "å®¢æˆ·",
      "entityName": "customer",
      "views": [
        {
          "viewId": "...",
          "viewName": "æ‰€æœ‰å®¢æˆ·",
          "viewType": 0
        }
      ]
    }
  ]
}
```

### 2. å·¥ä½œè¡¨ç»“æ„

#### è·å–å·¥ä½œè¡¨è¯¦æƒ…

```javascript
// GET /v3/app/worksheets/{worksheet_id}
const response = await fetch(
  `https://api.mingdao.com/v3/app/worksheets/${worksheetId}`,
  {
    method: 'GET',
    headers: {
      'HAP-Appkey': appkey,
      'HAP-Sign': sign
    }
  }
);

const worksheet = await response.json();
```

**å“åº”æ•°æ®:**
```json
{
  "worksheetId": "69563e5df03728c888c04f05",
  "worksheetName": "å®¢æˆ·",
  "controls": [
    {
      "controlId": "name",
      "controlName": "å®¢æˆ·åç§°",
      "type": 2,
      "required": true
    },
    {
      "controlId": "industry",
      "controlName": "æ‰€å±è¡Œä¸š",
      "type": 9,
      "options": [
        { "key": "key1", "value": "äº’è”ç½‘" },
        { "key": "key2", "value": "é‡‘è" }
      ]
    }
  ]
}
```

### 3. æ•°æ®æŸ¥è¯¢

#### è·å–è®°å½•åˆ—è¡¨

```javascript
// POST /v3/app/worksheets/{worksheet_id}/rows/list
const response = await fetch(
  `https://api.mingdao.com/v3/app/worksheets/${worksheetId}/rows/list`,
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'HAP-Appkey': appkey,
      'HAP-Sign': sign
    },
    body: JSON.stringify({
      pageIndex: 1,
      pageSize: 50,
      sortId: 'ctime',
      isAsc: false,
      filters: {
        // ç­›é€‰æ¡ä»¶
      }
    })
  }
);

const { rows, total } = await response.json();
```

**å®Œæ•´ç¤ºä¾‹:**
```javascript
async function getCustomers() {
  const response = await fetch(
    `https://api.mingdao.com/v3/app/worksheets/${worksheetId}/rows/list`,
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'HAP-Appkey': appkey,
        'HAP-Sign': sign
      },
      body: JSON.stringify({
        pageIndex: 1,
        pageSize: 100,
        sortId: 'ctime',
        isAsc: false,
        filters: {
          filterControls: [
            {
              controlId: 'status',
              dataType: 9,
              spliceType: 1,
              filterType: 2,
              values: ['active_key']
            }
          ]
        }
      })
    }
  );

  const result = await response.json();
  return result.rows;
}
```

#### è·å–å•æ¡è®°å½•è¯¦æƒ…

```javascript
// GET /v3/app/worksheets/{worksheet_id}/rows/{row_id}
const response = await fetch(
  `https://api.mingdao.com/v3/app/worksheets/${worksheetId}/rows/${rowId}`,
  {
    method: 'GET',
    headers: {
      'HAP-Appkey': appkey,
      'HAP-Sign': sign
    }
  }
);

const row = await response.json();
```

### 4. æ•°æ®æ“ä½œ

#### åˆ›å»ºè®°å½•

```javascript
// POST /v3/app/worksheets/{worksheet_id}/rows
const response = await fetch(
  `https://api.mingdao.com/v3/app/worksheets/${worksheetId}/rows`,
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'HAP-Appkey': appkey,
      'HAP-Sign': sign
    },
    body: JSON.stringify({
      controls: [
        {
          controlId: 'name',
          type: 2,
          value: 'æ–°å®¢æˆ·åç§°'
        },
        {
          controlId: 'industry',
          type: 9,
          value: JSON.stringify(['key1'])
        }
      ]
    })
  }
);

const newRow = await response.json();
```

#### æ›´æ–°è®°å½•

```javascript
// PUT /v3/app/worksheets/{worksheet_id}/rows/{row_id}
const response = await fetch(
  `https://api.mingdao.com/v3/app/worksheets/${worksheetId}/rows/${rowId}`,
  {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'HAP-Appkey': appkey,
      'HAP-Sign': sign
    },
    body: JSON.stringify({
      controls: [
        {
          controlId: 'status',
          type: 9,
          value: JSON.stringify(['new_status_key'])
        }
      ]
    })
  }
);
```

#### åˆ é™¤è®°å½•

```javascript
// DELETE /v3/app/worksheets/{worksheet_id}/rows/batch
const response = await fetch(
  `https://api.mingdao.com/v3/app/worksheets/${worksheetId}/rows/batch`,
  {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
      'HAP-Appkey': appkey,
      'HAP-Sign': sign
    },
    body: JSON.stringify({
      rowIds: [rowId1, rowId2]
    })
  }
);
```

### 5. å…³è”è®°å½•

#### è·å–å…³è”è®°å½•

```javascript
// GET /v3/app/worksheets/{worksheet_id}/rows/{row_id}/relations/{field}
const response = await fetch(
  `https://api.mingdao.com/v3/app/worksheets/${worksheetId}/rows/${rowId}/relations/${fieldId}`,
  {
    method: 'GET',
    headers: {
      'HAP-Appkey': appkey,
      'HAP-Sign': sign
    }
  }
);

const relations = await response.json();
```

### 6. é€‰é¡¹é›†ç®¡ç†

#### è·å–é€‰é¡¹é›†åˆ—è¡¨

```javascript
// GET /v3/app/optionsets
const response = await fetch(
  'https://api.mingdao.com/v3/app/optionsets',
  {
    method: 'GET',
    headers: {
      'HAP-Appkey': appkey,
      'HAP-Sign': sign
    }
  }
);

const optionSets = await response.json();
```

#### è·å–é€‰é¡¹é›†è¯¦æƒ…

```javascript
// GET /v3/app/optionsets/{optionset_id}
const response = await fetch(
  `https://api.mingdao.com/v3/app/optionsets/${optionsetId}`,
  {
    method: 'GET',
    headers: {
      'HAP-Appkey': appkey,
      'HAP-Sign': sign
    }
  }
);

const optionSet = await response.json();
```

### 7. è§’è‰²å’Œæˆå‘˜ç®¡ç†

#### è·å–è§’è‰²åˆ—è¡¨

```javascript
// GET /v3/app/roles
const response = await fetch(
  'https://api.mingdao.com/v3/app/roles',
  {
    method: 'GET',
    headers: {
      'HAP-Appkey': appkey,
      'HAP-Sign': sign
    }
  }
);

const roles = await response.json();
```

#### è·å–è§’è‰²æˆå‘˜

```javascript
// GET /v3/app/roles/{role_id}/members
const response = await fetch(
  `https://api.mingdao.com/v3/app/roles/${roleId}/members`,
  {
    method: 'GET',
    headers: {
      'HAP-Appkey': appkey,
      'HAP-Sign': sign
    }
  }
);

const members = await response.json();
```

### 8. ç”¨æˆ·å’Œéƒ¨é—¨æŸ¥è¯¢

#### æŸ¥è¯¢ç”¨æˆ·

```javascript
// POST /v3/users/lookup
const response = await fetch(
  'https://api.mingdao.com/v3/users/lookup',
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'HAP-Appkey': appkey,
      'HAP-Sign': sign
    },
    body: JSON.stringify({
      keywords: 'å¼ ä¸‰',
      pageIndex: 1,
      pageSize: 20
    })
  }
);

const users = await response.json();
```

#### æŸ¥è¯¢éƒ¨é—¨

```javascript
// POST /v3/departments/lookup
const response = await fetch(
  'https://api.mingdao.com/v3/departments/lookup',
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'HAP-Appkey': appkey,
      'HAP-Sign': sign
    },
    body: JSON.stringify({
      keywords: 'é”€å”®éƒ¨',
      pageIndex: 1,
      pageSize: 20
    })
  }
);

const departments = await response.json();
```

## ç­›é€‰å™¨ä½¿ç”¨è§„èŒƒ

### ç­›é€‰æ¡ä»¶ç»“æ„

```javascript
const filters = {
  filterControls: [
    {
      controlId: 'status',        // å­—æ®µ ID
      dataType: 9,                // å­—æ®µç±»å‹
      spliceType: 1,              // è¿æ¥æ–¹å¼: 1=ä¸”, 2=æˆ–
      filterType: 2,              // ç­›é€‰ç±»å‹
      values: ['key1', 'key2']    // ç­›é€‰å€¼
    }
  ],
  conjunction: 1  // å¤šä¸ªç­›é€‰æ¡ä»¶ä¹‹é—´çš„å…³ç³»: 1=ä¸”, 2=æˆ–
};
```

### å¸¸ç”¨ç­›é€‰ç±»å‹ (filterType)

| filterType | å«ä¹‰ | é€‚ç”¨å­—æ®µç±»å‹ | values ç¤ºä¾‹ |
|-----------|------|------------|-----------|
| 1 | ä¸ºç©º | æ‰€æœ‰ | [] |
| 2 | ç­‰äº | æ‰€æœ‰ | ['value'] |
| 3 | ä¸ç­‰äº | æ‰€æœ‰ | ['value'] |
| 4 | åŒ…å« | æ–‡æœ¬ | ['keyword'] |
| 5 | ä¸åŒ…å« | æ–‡æœ¬ | ['keyword'] |
| 6 | å¼€å¤´æ˜¯ | æ–‡æœ¬ | ['prefix'] |
| 7 | ç»“å°¾æ˜¯ | æ–‡æœ¬ | ['suffix'] |
| 14 | å¤§äº | æ•°å€¼/æ—¥æœŸ | ['100'] |
| 15 | å¤§äºç­‰äº | æ•°å€¼/æ—¥æœŸ | ['100'] |
| 16 | å°äº | æ•°å€¼/æ—¥æœŸ | ['100'] |
| 17 | å°äºç­‰äº | æ•°å€¼/æ—¥æœŸ | ['100'] |
| 24 | æ˜¯(ä»»æ„ä¸€ä¸ª) | é€‰é¡¹/æˆå‘˜ | ['key1','key2'] |
| 25 | ä¸æ˜¯(ä»»æ„ä¸€ä¸ª) | é€‰é¡¹/æˆå‘˜ | ['key1','key2'] |

### ç­›é€‰ç¤ºä¾‹

#### ç¤ºä¾‹1: ç­›é€‰å•é€‰å­—æ®µ

```javascript
// ç­›é€‰çŠ¶æ€ä¸º"è¿›è¡Œä¸­"çš„è®°å½•
const filters = {
  filterControls: [
    {
      controlId: 'status',
      dataType: 9,          // å•é€‰
      spliceType: 1,
      filterType: 2,        // ç­‰äº
      values: ['status_key_inprogress']
    }
  ]
};
```

#### ç¤ºä¾‹2: ç­›é€‰æ—¥æœŸèŒƒå›´

```javascript
// ç­›é€‰æœ¬æœˆåˆ›å»ºçš„è®°å½•
const startOfMonth = '2024-01-01';
const endOfMonth = '2024-01-31';

const filters = {
  filterControls: [
    {
      controlId: 'ctime',
      dataType: 16,         // æ—¥æœŸæ—¶é—´
      spliceType: 1,
      filterType: 15,       // å¤§äºç­‰äº
      values: [startOfMonth]
    },
    {
      controlId: 'ctime',
      dataType: 16,
      spliceType: 1,
      filterType: 17,       // å°äºç­‰äº
      values: [endOfMonth]
    }
  ],
  conjunction: 1  // ä¸”
};
```

#### ç¤ºä¾‹3: ç­›é€‰æˆå‘˜å­—æ®µ

```javascript
// ç­›é€‰è´Ÿè´£äººæ˜¯"å¼ ä¸‰"æˆ–"æå››"çš„è®°å½•
const filters = {
  filterControls: [
    {
      controlId: 'owner',
      dataType: 26,         // æˆå‘˜
      spliceType: 1,
      filterType: 24,       // æ˜¯(ä»»æ„ä¸€ä¸ª)
      values: [
        'accountId_zhangsan',
        'accountId_lisi'
      ]
    }
  ]
};
```

#### ç¤ºä¾‹4: ç»„åˆç­›é€‰

```javascript
// ç­›é€‰çŠ¶æ€ä¸º"è¿›è¡Œä¸­"ä¸”è´Ÿè´£äººæ˜¯"å¼ ä¸‰"çš„è®°å½•
const filters = {
  filterControls: [
    {
      controlId: 'status',
      dataType: 9,
      spliceType: 1,
      filterType: 2,
      values: ['status_key_inprogress']
    },
    {
      controlId: 'owner',
      dataType: 26,
      spliceType: 1,
      filterType: 24,
      values: ['accountId_zhangsan']
    }
  ],
  conjunction: 1  // ä¸”
};
```

## åœ¨è§†å›¾æ’ä»¶ä¸­ä½¿ç”¨ V3 æ¥å£

### æ–¹æ¡ˆ1: ä½¿ç”¨ mdye å°è£…çš„ api

åœ¨æ˜é“äº‘è§†å›¾æ’ä»¶ä¸­,æ¨èä½¿ç”¨ `mdye` æä¾›çš„å°è£…å¥½çš„ API:

```javascript
import { api, config } from 'mdye';

// å·²ç»åŒ…å«äº†é‰´æƒ,æ— éœ€æ‰‹åŠ¨é…ç½®
const { appId, worksheetId } = config;

// ç›´æ¥è°ƒç”¨
const result = await api.getFilterRows({
  worksheetId,
  viewId: config.viewId,
  pageSize: 50
});
```

### æ–¹æ¡ˆ2: ç›´æ¥è°ƒç”¨ V3 æ¥å£

å¦‚æœéœ€è¦è°ƒç”¨ mdye æœªå°è£…çš„æ¥å£:

```javascript
async function callV3API(endpoint, method = 'GET', body = null) {
  const headers = {
    'Content-Type': 'application/json',
    'HAP-Appkey': YOUR_APPKEY,
    'HAP-Sign': YOUR_SIGN
  };

  const options = {
    method,
    headers
  };

  if (body) {
    options.body = JSON.stringify(body);
  }

  const response = await fetch(
    `https://api.mingdao.com${endpoint}`,
    options
  );

  return await response.json();
}

// ä½¿ç”¨ç¤ºä¾‹
const optionSets = await callV3API('/v3/app/optionsets', 'GET');
```

## åœ¨ç‹¬ç«‹é¡µé¢ä¸­ä½¿ç”¨ V3 æ¥å£

### å®Œæ•´çš„ React ç¤ºä¾‹

```javascript
import React, { useState, useEffect } from 'react';

// é…ç½®
const API_CONFIG = {
  baseURL: 'https://api.mingdao.com',
  appkey: '881f73bb18ad7b7d',
  sign: 'NTk4OGRhYzkzMzkxOGMxZWVlZDRlN2ZmMzhkN2JjZDM2ODAwOGVmMTI5NTQwODA3ZGI4NTBmOGMzOTlkNmE4ZA=='
};

// å°è£…è¯·æ±‚å‡½æ•°
async function hapRequest(endpoint, options = {}) {
  const headers = {
    'Content-Type': 'application/json',
    'HAP-Appkey': API_CONFIG.appkey,
    'HAP-Sign': API_CONFIG.sign,
    ...options.headers
  };

  const response = await fetch(`${API_CONFIG.baseURL}${endpoint}`, {
    ...options,
    headers
  });

  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }

  return await response.json();
}

// ç»„ä»¶ç¤ºä¾‹
function CustomerList() {
  const [customers, setCustomers] = useState([]);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    loadCustomers();
  }, []);

  async function loadCustomers() {
    setLoading(true);
    try {
      const result = await hapRequest(
        '/v3/app/worksheets/69563e5df03728c888c04f05/rows/list',
        {
          method: 'POST',
          body: JSON.stringify({
            pageIndex: 1,
            pageSize: 100,
            sortId: 'ctime',
            isAsc: false
          })
        }
      );

      setCustomers(result.rows || []);
    } catch (error) {
      console.error('åŠ è½½å®¢æˆ·å¤±è´¥:', error);
    } finally {
      setLoading(false);
    }
  }

  async function createCustomer(data) {
    try {
      const result = await hapRequest(
        '/v3/app/worksheets/69563e5df03728c888c04f05/rows',
        {
          method: 'POST',
          body: JSON.stringify({
            controls: [
              {
                controlId: 'name',
                type: 2,
                value: data.name
              },
              {
                controlId: 'industry',
                type: 9,
                value: JSON.stringify([data.industryKey])
              }
            ]
          })
        }
      );

      // åˆ·æ–°åˆ—è¡¨
      loadCustomers();
      return result;
    } catch (error) {
      console.error('åˆ›å»ºå®¢æˆ·å¤±è´¥:', error);
      throw error;
    }
  }

  return (
    <div>
      <h1>å®¢æˆ·åˆ—è¡¨</h1>
      {loading ? (
        <p>åŠ è½½ä¸­...</p>
      ) : (
        <ul>
          {customers.map(customer => (
            <li key={customer.rowid}>
              {customer.name}
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}

export default CustomerList;
```

## æœ€ä½³å®è·µ

### 1. é‰´æƒä¿¡æ¯ç®¡ç†

```javascript
// âœ… æ¨è: ä½¿ç”¨ç¯å¢ƒå˜é‡
const API_CONFIG = {
  appkey: process.env.REACT_APP_HAP_APPKEY,
  sign: process.env.REACT_APP_HAP_SIGN
};

// âŒ ä¸æ¨è: ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
const appkey = '881f73bb18ad7b7d';
```

### 2. é”™è¯¯å¤„ç†

```javascript
async function safeHapRequest(endpoint, options) {
  try {
    const result = await hapRequest(endpoint, options);
    return { success: true, data: result };
  } catch (error) {
    console.error('API è°ƒç”¨å¤±è´¥:', error);
    return { success: false, error: error.message };
  }
}
```

### 3. è¯·æ±‚å°è£…

```javascript
class HapAPI {
  constructor(appkey, sign) {
    this.appkey = appkey;
    this.sign = sign;
    this.baseURL = 'https://api.mingdao.com';
  }

  async request(endpoint, options = {}) {
    const headers = {
      'Content-Type': 'application/json',
      'HAP-Appkey': this.appkey,
      'HAP-Sign': this.sign,
      ...options.headers
    };

    const response = await fetch(`${this.baseURL}${endpoint}`, {
      ...options,
      headers
    });

    return await response.json();
  }

  // å·¥ä½œè¡¨æ“ä½œ
  async getWorksheetRows(worksheetId, params) {
    return this.request(
      `/v3/app/worksheets/${worksheetId}/rows/list`,
      {
        method: 'POST',
        body: JSON.stringify(params)
      }
    );
  }

  async createRow(worksheetId, controls) {
    return this.request(
      `/v3/app/worksheets/${worksheetId}/rows`,
      {
        method: 'POST',
        body: JSON.stringify({ controls })
      }
    );
  }

  async updateRow(worksheetId, rowId, controls) {
    return this.request(
      `/v3/app/worksheets/${worksheetId}/rows/${rowId}`,
      {
        method: 'PUT',
        body: JSON.stringify({ controls })
      }
    );
  }

  async deleteRows(worksheetId, rowIds) {
    return this.request(
      `/v3/app/worksheets/${worksheetId}/rows/batch`,
      {
        method: 'DELETE',
        body: JSON.stringify({ rowIds })
      }
    );
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const api = new HapAPI(appkey, sign);
const rows = await api.getWorksheetRows(worksheetId, {
  pageIndex: 1,
  pageSize: 50
});
```

### 4. æ€§èƒ½ä¼˜åŒ–

```javascript
// ä½¿ç”¨é˜²æŠ–å‡å°‘è¯·æ±‚é¢‘ç‡
import { debounce } from 'lodash';

const debouncedSearch = debounce(async (keyword) => {
  const result = await hapRequest('/v3/app/worksheets/.../rows/list', {
    method: 'POST',
    body: JSON.stringify({
      filters: {
        filterControls: [{
          controlId: 'name',
          dataType: 2,
          filterType: 4,
          values: [keyword]
        }]
      }
    })
  });
  setResults(result.rows);
}, 300);

// ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤è¯·æ±‚
const cache = new Map();

async function cachedRequest(key, requestFn) {
  if (cache.has(key)) {
    return cache.get(key);
  }

  const result = await requestFn();
  cache.set(key, result);
  return result;
}
```

## å¸¸è§é—®é¢˜

### é—®é¢˜1: CORS è·¨åŸŸé”™è¯¯

**é”™è¯¯ä¿¡æ¯:**
```
Access to fetch at 'https://api.mingdao.com/v3/...' from origin 'http://localhost:3000'
has been blocked by CORS policy
```

**è§£å†³æ–¹æ¡ˆ:**
1. ä½¿ç”¨ä»£ç†æœåŠ¡å™¨
2. åœ¨æœåŠ¡ç«¯è°ƒç”¨æ¥å£
3. ä½¿ç”¨æ˜é“äº‘è§†å›¾æ’ä»¶(è‡ªåŠ¨å¤„ç† CORS)

### é—®é¢˜2: é‰´æƒå¤±è´¥

**é”™è¯¯ä¿¡æ¯:**
```json
{
  "error_code": 401,
  "error_msg": "Unauthorized"
}
```

**è§£å†³æ–¹æ¡ˆ:**
- æ£€æŸ¥ Appkey å’Œ Sign æ˜¯å¦æ­£ç¡®
- ç¡®è®¤è¯·æ±‚å¤´æ ¼å¼æ­£ç¡®
- éªŒè¯åº”ç”¨æ˜¯å¦æœ‰æƒè®¿é—®ç›®æ ‡èµ„æº

### é—®é¢˜3: ç­›é€‰æ¡ä»¶ä¸ç”Ÿæ•ˆ

**å¸¸è§åŸå› :**
- filterType ä½¿ç”¨é”™è¯¯
- dataType ä¸å­—æ®µå®é™…ç±»å‹ä¸åŒ¹é…
- values æ ¼å¼ä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆ:**
- é€šè¿‡ MCP æŸ¥è¯¢ API æ–‡æ¡£
- æŸ¥çœ‹å­—æ®µå®šä¹‰ç¡®è®¤ dataType
- å‚è€ƒæœ¬æ–‡æ¡£çš„ç­›é€‰ç¤ºä¾‹

## æ€»ç»“

ä½¿ç”¨ HAP V3 æ¥å£çš„å…³é”®ç‚¹:

1. **é‰´æƒé…ç½®**: æ­£ç¡®è®¾ç½® Appkey å’Œ Sign
2. **æ¥å£è°ƒç”¨**: éµå¾ªæ ‡å‡†çš„ RESTful è§„èŒƒ
3. **ç­›é€‰å™¨**: ç†è§£ filterType å’Œ dataType çš„å¯¹åº”å…³ç³»
4. **é”™è¯¯å¤„ç†**: åšå¥½å¼‚å¸¸æ•è·å’Œç”¨æˆ·æç¤º
5. **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨ç¼“å­˜ã€é˜²æŠ–ç­‰æŠ€æœ¯
6. **CORS å¤„ç†**: æ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„è·¨åŸŸæ–¹æ¡ˆ

## å‚è€ƒèµ„æº

- æ˜é“äº‘ HAP å¼€å‘è€…æ–‡æ¡£
- Apifox MCP Server (æŸ¥è¯¢ API æ–‡æ¡£)
- HAP è§†å›¾æ’ä»¶å¼€å‘æŠ€èƒ½
- æ˜é“äº‘å¼€å‘è€…ç¤¾åŒº

---

**æ³¨æ„:** æœ¬æŠ€èƒ½æä¾›çš„æ˜¯ HAP V3 æ¥å£ä½¿ç”¨æŒ‡å—,å®é™…ä½¿ç”¨æ—¶è¯·æ ¹æ®å…·ä½“ä¸šåŠ¡éœ€æ±‚è°ƒæ•´æ¥å£å‚æ•°å’Œå¤„ç†é€»è¾‘ã€‚
